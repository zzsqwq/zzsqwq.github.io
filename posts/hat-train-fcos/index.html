<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹ | Zs's Blog</title><meta name=keywords content="HAT,Horizon Robotics,FCOS"><meta name=description content="å‰è¨€ æœ€è¿‘æƒ³è¦ä½¿ç”¨è‡ªå·±é‡‡é›†ä¸æ ‡æ³¨çš„æ•°æ®é›†æ¥è®­ç»ƒä¸éƒ¨ç½²ä¸€ä¸‹åœ°å¹³çº¿å¾®è°ƒè¿‡çš„ FCOS ç½‘ç»œï¼Œåœ¨è¯¢é—®å’ŒæŸ¥çœ‹æ–‡æ¡£åå‘ç°å¦‚æœæƒ³åŸºäºå®˜æ–¹å¾®è°ƒçš„æ¨¡å‹è®­ç»ƒï¼Œéœ€è¦ä½¿ç”¨æä¾› HATï¼ˆHorizon Algorithm Toolkitï¼Œæµ·å›¾ï¼‰ æ¥è¿›è¡Œï¼Œå…·ä½“çš„æ–‡æ¡£å¯ä»¥æŸ¥çœ‹ï¼šHorizon Algorithm Toolkit æ–‡æ¡£ï¼Œè¿™æ˜¯åœ¨çº¿çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å¯èƒ½ä¼šæ¯”è¾ƒæ—§ï¼Œæƒ³çœ‹æœ€æ–°ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ç¦»çº¿çš„ç‰ˆæœ¬ï¼Œä½ç½®åœ¨ OEï¼ˆOpen Explorerï¼Œå¤©å·¥å¼€ç‰©ï¼‰ åŒ…çš„ doc ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š
æƒ³è¦æ–¹ä¾¿çš„æŸ¥çœ‹ç¦»çº¿æ–‡æ¡£å¯ä»¥é€šè¿‡ Python æ¥å®ç°ï¼Œåœ¨ doc ç›®å½•ä¸‹æ‰§è¡Œï¼š
python3 -m http.server 3000 è¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°çš„ 0.0.0.0:3000 åœ°å€å¼€å¯ä¸€ä¸ª http serverï¼Œéšåå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä½¿ç”¨ localhost:3000 æˆ–è€…å…¶ä»–ç”µè„‘æµè§ˆå™¨ä½¿ç”¨ {ip}:3000 æ¥è®¿é—®æ–‡æ¡£ã€‚
ä½†æ˜¯æŸ¥çœ‹ æ–‡æ¡£ è¿‡åä¼šå‘ç°ï¼Œæ–‡æ¡£å…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å…¨é¢ï¼Œè®²çš„æ¯”è¾ƒç®€å•ï¼Œå°è¯•äº†ä¸€ä¸‹ä¸­é—´å‘è¿˜æŒºå¤šçš„ï¼Œç¤¾åŒºé‡Œé¢å…³äºè¿™æ–¹é¢çš„å¸–å­ä¹Ÿä¸å¤š12ï¼Œå› æ­¤æƒ³è®°å½•ä¸‹æˆ‘å°è¯•çš„å…¨æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹ä¸Šé¢æ•™ç¨‹æ–‡æ¡£çš„è¡¥å……ã€‚
ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š
è®­ç»ƒçš„ç¯å¢ƒé…ç½®ã€‚
å¦‚ä½•åŸºäºå®˜æ–¹çš„ COCO æ•°æ®é›†è®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡åŸºäº mscoco å‘å¸ƒçš„åŒ…å« 80 ç±»çš„æ•°æ®é›†ã€‚
å¦‚ä½•åŸºäºè‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡è‡ªå·±å»ºç«‹çš„ï¼Œè‡ªå®šä¹‰ç±»åˆ«çš„ï¼Œå¯èƒ½åªæœ‰å››äº”ç±»ï¼Œæ²¡æœ‰ 80 ç±»çš„æ•°æ®é›†ã€‚
ä¸‹æ–¹æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ Github ä»“åº“ ä¸­æ‰¾åˆ°ã€‚
è®­ç»ƒçš„ç¯å¢ƒé…ç½® æˆ‘è‡ªå·±ç¯å¢ƒé…ç½®å¦‚ä¸‹ï¼š
OS: Ubuntu 20.04
Docker: 20.10.23
Nvidia Docker: 2.11.0-1
GPU: RTX3090
NVIDIA Driver Version: 515.65.01
CUDA Version: 11."><meta name=author content="zzsqwq"><link rel=canonical href=https://blog.zzsqwq.cn/posts/hat-train-fcos/><meta name=google-site-verification content="G-WF7TH97J9X"><link crossorigin=anonymous href=/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css integrity="sha256-DE/TclFxNm8zUVWs3m+zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.zzsqwq.cn/images/avatar.png><link rel=icon type=image/png sizes=16x16 href=https://blog.zzsqwq.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.zzsqwq.cn/images/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.zzsqwq.cn/apple-touch-icon.png><link rel=mask-icon href=https://blog.zzsqwq.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-WF7TH97J9X"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WF7TH97J9X",{anonymize_ip:!1})}</script><meta property="og:title" content="åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹"><meta property="og:description" content="å‰è¨€ æœ€è¿‘æƒ³è¦ä½¿ç”¨è‡ªå·±é‡‡é›†ä¸æ ‡æ³¨çš„æ•°æ®é›†æ¥è®­ç»ƒä¸éƒ¨ç½²ä¸€ä¸‹åœ°å¹³çº¿å¾®è°ƒè¿‡çš„ FCOS ç½‘ç»œï¼Œåœ¨è¯¢é—®å’ŒæŸ¥çœ‹æ–‡æ¡£åå‘ç°å¦‚æœæƒ³åŸºäºå®˜æ–¹å¾®è°ƒçš„æ¨¡å‹è®­ç»ƒï¼Œéœ€è¦ä½¿ç”¨æä¾› HATï¼ˆHorizon Algorithm Toolkitï¼Œæµ·å›¾ï¼‰ æ¥è¿›è¡Œï¼Œå…·ä½“çš„æ–‡æ¡£å¯ä»¥æŸ¥çœ‹ï¼šHorizon Algorithm Toolkit æ–‡æ¡£ï¼Œè¿™æ˜¯åœ¨çº¿çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å¯èƒ½ä¼šæ¯”è¾ƒæ—§ï¼Œæƒ³çœ‹æœ€æ–°ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ç¦»çº¿çš„ç‰ˆæœ¬ï¼Œä½ç½®åœ¨ OEï¼ˆOpen Explorerï¼Œå¤©å·¥å¼€ç‰©ï¼‰ åŒ…çš„ doc ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š
æƒ³è¦æ–¹ä¾¿çš„æŸ¥çœ‹ç¦»çº¿æ–‡æ¡£å¯ä»¥é€šè¿‡ Python æ¥å®ç°ï¼Œåœ¨ doc ç›®å½•ä¸‹æ‰§è¡Œï¼š
python3 -m http.server 3000 è¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°çš„ 0.0.0.0:3000 åœ°å€å¼€å¯ä¸€ä¸ª http serverï¼Œéšåå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä½¿ç”¨ localhost:3000 æˆ–è€…å…¶ä»–ç”µè„‘æµè§ˆå™¨ä½¿ç”¨ {ip}:3000 æ¥è®¿é—®æ–‡æ¡£ã€‚
ä½†æ˜¯æŸ¥çœ‹ æ–‡æ¡£ è¿‡åä¼šå‘ç°ï¼Œæ–‡æ¡£å…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å…¨é¢ï¼Œè®²çš„æ¯”è¾ƒç®€å•ï¼Œå°è¯•äº†ä¸€ä¸‹ä¸­é—´å‘è¿˜æŒºå¤šçš„ï¼Œç¤¾åŒºé‡Œé¢å…³äºè¿™æ–¹é¢çš„å¸–å­ä¹Ÿä¸å¤š12ï¼Œå› æ­¤æƒ³è®°å½•ä¸‹æˆ‘å°è¯•çš„å…¨æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹ä¸Šé¢æ•™ç¨‹æ–‡æ¡£çš„è¡¥å……ã€‚
ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š
è®­ç»ƒçš„ç¯å¢ƒé…ç½®ã€‚
å¦‚ä½•åŸºäºå®˜æ–¹çš„ COCO æ•°æ®é›†è®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡åŸºäº mscoco å‘å¸ƒçš„åŒ…å« 80 ç±»çš„æ•°æ®é›†ã€‚
å¦‚ä½•åŸºäºè‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡è‡ªå·±å»ºç«‹çš„ï¼Œè‡ªå®šä¹‰ç±»åˆ«çš„ï¼Œå¯èƒ½åªæœ‰å››äº”ç±»ï¼Œæ²¡æœ‰ 80 ç±»çš„æ•°æ®é›†ã€‚
ä¸‹æ–¹æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ Github ä»“åº“ ä¸­æ‰¾åˆ°ã€‚
è®­ç»ƒçš„ç¯å¢ƒé…ç½® æˆ‘è‡ªå·±ç¯å¢ƒé…ç½®å¦‚ä¸‹ï¼š
OS: Ubuntu 20.04
Docker: 20.10.23
Nvidia Docker: 2.11.0-1
GPU: RTX3090
NVIDIA Driver Version: 515.65.01
CUDA Version: 11."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.zzsqwq.cn/posts/hat-train-fcos/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-25T00:45:22+08:00"><meta property="article:modified_time" content="2023-02-25T00:45:22+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹"><meta name=twitter:description content="å‰è¨€ æœ€è¿‘æƒ³è¦ä½¿ç”¨è‡ªå·±é‡‡é›†ä¸æ ‡æ³¨çš„æ•°æ®é›†æ¥è®­ç»ƒä¸éƒ¨ç½²ä¸€ä¸‹åœ°å¹³çº¿å¾®è°ƒè¿‡çš„ FCOS ç½‘ç»œï¼Œåœ¨è¯¢é—®å’ŒæŸ¥çœ‹æ–‡æ¡£åå‘ç°å¦‚æœæƒ³åŸºäºå®˜æ–¹å¾®è°ƒçš„æ¨¡å‹è®­ç»ƒï¼Œéœ€è¦ä½¿ç”¨æä¾› HATï¼ˆHorizon Algorithm Toolkitï¼Œæµ·å›¾ï¼‰ æ¥è¿›è¡Œï¼Œå…·ä½“çš„æ–‡æ¡£å¯ä»¥æŸ¥çœ‹ï¼šHorizon Algorithm Toolkit æ–‡æ¡£ï¼Œè¿™æ˜¯åœ¨çº¿çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å¯èƒ½ä¼šæ¯”è¾ƒæ—§ï¼Œæƒ³çœ‹æœ€æ–°ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ç¦»çº¿çš„ç‰ˆæœ¬ï¼Œä½ç½®åœ¨ OEï¼ˆOpen Explorerï¼Œå¤©å·¥å¼€ç‰©ï¼‰ åŒ…çš„ doc ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š
æƒ³è¦æ–¹ä¾¿çš„æŸ¥çœ‹ç¦»çº¿æ–‡æ¡£å¯ä»¥é€šè¿‡ Python æ¥å®ç°ï¼Œåœ¨ doc ç›®å½•ä¸‹æ‰§è¡Œï¼š
python3 -m http.server 3000 è¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°çš„ 0.0.0.0:3000 åœ°å€å¼€å¯ä¸€ä¸ª http serverï¼Œéšåå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä½¿ç”¨ localhost:3000 æˆ–è€…å…¶ä»–ç”µè„‘æµè§ˆå™¨ä½¿ç”¨ {ip}:3000 æ¥è®¿é—®æ–‡æ¡£ã€‚
ä½†æ˜¯æŸ¥çœ‹ æ–‡æ¡£ è¿‡åä¼šå‘ç°ï¼Œæ–‡æ¡£å…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å…¨é¢ï¼Œè®²çš„æ¯”è¾ƒç®€å•ï¼Œå°è¯•äº†ä¸€ä¸‹ä¸­é—´å‘è¿˜æŒºå¤šçš„ï¼Œç¤¾åŒºé‡Œé¢å…³äºè¿™æ–¹é¢çš„å¸–å­ä¹Ÿä¸å¤š12ï¼Œå› æ­¤æƒ³è®°å½•ä¸‹æˆ‘å°è¯•çš„å…¨æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹ä¸Šé¢æ•™ç¨‹æ–‡æ¡£çš„è¡¥å……ã€‚
ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š
è®­ç»ƒçš„ç¯å¢ƒé…ç½®ã€‚
å¦‚ä½•åŸºäºå®˜æ–¹çš„ COCO æ•°æ®é›†è®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡åŸºäº mscoco å‘å¸ƒçš„åŒ…å« 80 ç±»çš„æ•°æ®é›†ã€‚
å¦‚ä½•åŸºäºè‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡è‡ªå·±å»ºç«‹çš„ï¼Œè‡ªå®šä¹‰ç±»åˆ«çš„ï¼Œå¯èƒ½åªæœ‰å››äº”ç±»ï¼Œæ²¡æœ‰ 80 ç±»çš„æ•°æ®é›†ã€‚
ä¸‹æ–¹æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ Github ä»“åº“ ä¸­æ‰¾åˆ°ã€‚
è®­ç»ƒçš„ç¯å¢ƒé…ç½® æˆ‘è‡ªå·±ç¯å¢ƒé…ç½®å¦‚ä¸‹ï¼š
OS: Ubuntu 20.04
Docker: 20.10.23
Nvidia Docker: 2.11.0-1
GPU: RTX3090
NVIDIA Driver Version: 515.65.01
CUDA Version: 11."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.zzsqwq.cn/posts/"},{"@type":"ListItem","position":3,"name":"åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹","item":"https://blog.zzsqwq.cn/posts/hat-train-fcos/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹","name":"åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹","description":"å‰è¨€ æœ€è¿‘æƒ³è¦ä½¿ç”¨è‡ªå·±é‡‡é›†ä¸æ ‡æ³¨çš„æ•°æ®é›†æ¥è®­ç»ƒä¸éƒ¨ç½²ä¸€ä¸‹åœ°å¹³çº¿å¾®è°ƒè¿‡çš„ FCOS ç½‘ç»œï¼Œåœ¨è¯¢é—®å’ŒæŸ¥çœ‹æ–‡æ¡£åå‘ç°å¦‚æœæƒ³åŸºäºå®˜æ–¹å¾®è°ƒçš„æ¨¡å‹è®­ç»ƒï¼Œéœ€è¦ä½¿ç”¨æä¾› HATï¼ˆHorizon Algorithm Toolkitï¼Œæµ·å›¾ï¼‰ æ¥è¿›è¡Œï¼Œå…·ä½“çš„æ–‡æ¡£å¯ä»¥æŸ¥çœ‹ï¼šHorizon Algorithm Toolkit æ–‡æ¡£ï¼Œè¿™æ˜¯åœ¨çº¿çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å¯èƒ½ä¼šæ¯”è¾ƒæ—§ï¼Œæƒ³çœ‹æœ€æ–°ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ç¦»çº¿çš„ç‰ˆæœ¬ï¼Œä½ç½®åœ¨ OEï¼ˆOpen Explorerï¼Œå¤©å·¥å¼€ç‰©ï¼‰ åŒ…çš„ doc ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š\næƒ³è¦æ–¹ä¾¿çš„æŸ¥çœ‹ç¦»çº¿æ–‡æ¡£å¯ä»¥é€šè¿‡ Python æ¥å®ç°ï¼Œåœ¨ doc ç›®å½•ä¸‹æ‰§è¡Œï¼š\npython3 -m http.server 3000 è¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°çš„ 0.0.0.0:3000 åœ°å€å¼€å¯ä¸€ä¸ª http serverï¼Œéšåå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä½¿ç”¨ localhost:3000 æˆ–è€…å…¶ä»–ç”µè„‘æµè§ˆå™¨ä½¿ç”¨ {ip}:3000 æ¥è®¿é—®æ–‡æ¡£ã€‚\nä½†æ˜¯æŸ¥çœ‹ æ–‡æ¡£ è¿‡åä¼šå‘ç°ï¼Œæ–‡æ¡£å…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å…¨é¢ï¼Œè®²çš„æ¯”è¾ƒç®€å•ï¼Œå°è¯•äº†ä¸€ä¸‹ä¸­é—´å‘è¿˜æŒºå¤šçš„ï¼Œç¤¾åŒºé‡Œé¢å…³äºè¿™æ–¹é¢çš„å¸–å­ä¹Ÿä¸å¤š12ï¼Œå› æ­¤æƒ³è®°å½•ä¸‹æˆ‘å°è¯•çš„å…¨æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹ä¸Šé¢æ•™ç¨‹æ–‡æ¡£çš„è¡¥å……ã€‚\nä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\nè®­ç»ƒçš„ç¯å¢ƒé…ç½®ã€‚\nå¦‚ä½•åŸºäºå®˜æ–¹çš„ COCO æ•°æ®é›†è®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡åŸºäº mscoco å‘å¸ƒçš„åŒ…å« 80 ç±»çš„æ•°æ®é›†ã€‚\nå¦‚ä½•åŸºäºè‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡è‡ªå·±å»ºç«‹çš„ï¼Œè‡ªå®šä¹‰ç±»åˆ«çš„ï¼Œå¯èƒ½åªæœ‰å››äº”ç±»ï¼Œæ²¡æœ‰ 80 ç±»çš„æ•°æ®é›†ã€‚\nä¸‹æ–¹æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ Github ä»“åº“ ä¸­æ‰¾åˆ°ã€‚\nè®­ç»ƒçš„ç¯å¢ƒé…ç½® æˆ‘è‡ªå·±ç¯å¢ƒé…ç½®å¦‚ä¸‹ï¼š\nOS: Ubuntu 20.04\nDocker: 20.10.23\nNvidia Docker: 2.11.0-1\nGPU: RTX3090\nNVIDIA Driver Version: 515.65.01\nCUDA Version: 11.","keywords":["HAT","Horizon Robotics","FCOS"],"articleBody":"å‰è¨€ æœ€è¿‘æƒ³è¦ä½¿ç”¨è‡ªå·±é‡‡é›†ä¸æ ‡æ³¨çš„æ•°æ®é›†æ¥è®­ç»ƒä¸éƒ¨ç½²ä¸€ä¸‹åœ°å¹³çº¿å¾®è°ƒè¿‡çš„ FCOS ç½‘ç»œï¼Œåœ¨è¯¢é—®å’ŒæŸ¥çœ‹æ–‡æ¡£åå‘ç°å¦‚æœæƒ³åŸºäºå®˜æ–¹å¾®è°ƒçš„æ¨¡å‹è®­ç»ƒï¼Œéœ€è¦ä½¿ç”¨æä¾› HATï¼ˆHorizon Algorithm Toolkitï¼Œæµ·å›¾ï¼‰ æ¥è¿›è¡Œï¼Œå…·ä½“çš„æ–‡æ¡£å¯ä»¥æŸ¥çœ‹ï¼šHorizon Algorithm Toolkit æ–‡æ¡£ï¼Œè¿™æ˜¯åœ¨çº¿çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å¯èƒ½ä¼šæ¯”è¾ƒæ—§ï¼Œæƒ³çœ‹æœ€æ–°ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ç¦»çº¿çš„ç‰ˆæœ¬ï¼Œä½ç½®åœ¨ OEï¼ˆOpen Explorerï¼Œå¤©å·¥å¼€ç‰©ï¼‰ åŒ…çš„ doc ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š\næƒ³è¦æ–¹ä¾¿çš„æŸ¥çœ‹ç¦»çº¿æ–‡æ¡£å¯ä»¥é€šè¿‡ Python æ¥å®ç°ï¼Œåœ¨ doc ç›®å½•ä¸‹æ‰§è¡Œï¼š\npython3 -m http.server 3000 è¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°çš„ 0.0.0.0:3000 åœ°å€å¼€å¯ä¸€ä¸ª http serverï¼Œéšåå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä½¿ç”¨ localhost:3000 æˆ–è€…å…¶ä»–ç”µè„‘æµè§ˆå™¨ä½¿ç”¨ {ip}:3000 æ¥è®¿é—®æ–‡æ¡£ã€‚\nä½†æ˜¯æŸ¥çœ‹ æ–‡æ¡£ è¿‡åä¼šå‘ç°ï¼Œæ–‡æ¡£å…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å…¨é¢ï¼Œè®²çš„æ¯”è¾ƒç®€å•ï¼Œå°è¯•äº†ä¸€ä¸‹ä¸­é—´å‘è¿˜æŒºå¤šçš„ï¼Œç¤¾åŒºé‡Œé¢å…³äºè¿™æ–¹é¢çš„å¸–å­ä¹Ÿä¸å¤š12ï¼Œå› æ­¤æƒ³è®°å½•ä¸‹æˆ‘å°è¯•çš„å…¨æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹ä¸Šé¢æ•™ç¨‹æ–‡æ¡£çš„è¡¥å……ã€‚\nä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\nè®­ç»ƒçš„ç¯å¢ƒé…ç½®ã€‚\nå¦‚ä½•åŸºäºå®˜æ–¹çš„ COCO æ•°æ®é›†è®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡åŸºäº mscoco å‘å¸ƒçš„åŒ…å« 80 ç±»çš„æ•°æ®é›†ã€‚\nå¦‚ä½•åŸºäºè‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡è‡ªå·±å»ºç«‹çš„ï¼Œè‡ªå®šä¹‰ç±»åˆ«çš„ï¼Œå¯èƒ½åªæœ‰å››äº”ç±»ï¼Œæ²¡æœ‰ 80 ç±»çš„æ•°æ®é›†ã€‚\nä¸‹æ–¹æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ Github ä»“åº“ ä¸­æ‰¾åˆ°ã€‚\nè®­ç»ƒçš„ç¯å¢ƒé…ç½® æˆ‘è‡ªå·±ç¯å¢ƒé…ç½®å¦‚ä¸‹ï¼š\nOS: Ubuntu 20.04\nDocker: 20.10.23\nNvidia Docker: 2.11.0-1\nGPU: RTX3090\nNVIDIA Driver Version: 515.65.01\nCUDA Version: 11.7\nOE Version: v2.4.2( gcc-9.3.0 For XJ3 )\nå› ä¸ºæˆ‘çš„å¼€å‘æ˜¯åŸºäº Ubuntu è¿›è¡Œï¼Œè®­ç»ƒæ˜¯ GPU è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡ŒåªæåŠå…³äº Ubuntu + GPU è®­ç»ƒçš„ç¯å¢ƒé…ç½®ï¼ŒWindows æƒ…å†µä¸‹ï¼Œæˆ–è€…åªæœ‰ CPU çš„æƒ…å†µï¼Œæˆ‘ä¹Ÿæ²¡å°è¯•è¿‡ã€‚\né¦–å…ˆéœ€è¦å®‰è£… Docker ä»¥åŠ NVIDIA Dockerï¼Œå‰è€…å®‰è£…å‚è€ƒï¼šDocker å®‰è£…æ–‡æ¡£ï¼Œåè€…å®‰è£…å‚è€ƒï¼šNVIDIA Docker å®‰è£…æ–‡æ¡£ã€‚\nå‚è€ƒå®˜æ–¹ X3 èŠ¯ç‰‡æ–‡æ¡£ç¼–å†™å¯åŠ¨è„šæœ¬ run_docker.sh å¦‚ä¸‹ï¼š\n#!/bin/bash export version=v2.4.2 export ai_toolchain_package_path=/data/sunrise/horizon_oe_v2.4.2 export dataset_path=/data/datasets docker run -dt --runtime=nvidia -e NVIDIA_DRIVER_CAPABILITIES=compute,utility \\ -e NVIDIA_VISIBLE_DEVICES=all --shm-size=\"15g\" \\ --restart=always --network=host \\ -v \"$ai_toolchain_package_path\":/open_explorer \\ -v \"$dataset_path\":/data \\ openexplorer/ai_toolchain_centos_7_xj3:\"${version}\" å…¶ä¸­å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š\nversion ä»£è¡¨ Docker é•œåƒç‰ˆæœ¬ï¼Œå¯é€‰ç‰ˆæœ¬å‚è€ƒï¼šèµ„æ–™ä¸‹è½½ä¸“åŒº\nai_toolchain_package_path ä»£è¡¨ OE å¼€å‘åŒ…çš„è·¯å¾„ï¼ŒæŒ‡å®š OE åŒ…ä¸­ ai_toolchain çš„è·¯å¾„ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æˆ‘å»ºè®®æŠŠæ•´ä¸ª OE åŒ…éƒ½æŒ‚è¿›å»å¾—äº†ï¼Œæ²¡å•¥å·®åˆ«ã€‚\ndataset_path ä»£è¡¨è®­ç»ƒéœ€è¦çš„æ•°æ®é›†è·¯å¾„ï¼Œè¿™é‡Œå¯ä»¥æ–°å»ºä¸€ä¸ªç©ºçš„æ–‡ä»¶å¤¹ç„¶åæŒ‚è½½è¿›å»ï¼Œä¹Ÿå¯ä»¥æŠŠä½ æ‰€æœ‰çš„æ•°æ®é›†éƒ½å‡†å¤‡å¥½ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åæŒ‚è¿›å»ï¼Œéœ€è¦è®­ç»ƒå“ªä¸ªåé¢æŒ‡å®šå“ªä¸ªå³å¯ï¼Œæˆ‘ä»¬è¿™é‡Œæ–¹ä¾¿èµ·è§å¯ä»¥é€‰æ‹©å‰è€…ï¼ˆå®˜æ–¹è¯´å¦‚æœè¿™é‡ŒæŒ‡å®šä¸ºç©ºå¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œä½†æ˜¯æˆ‘æµ‹è¯•å‘ç°æŒ‚è½½ç©ºæ–‡ä»¶å¤¹ä¸ä¼šæœ‰é—®é¢˜ï¼‰ã€‚\ndocker run éƒ¨åˆ†å°±æ˜¯å¯åŠ¨ä¸€ä¸ª Docker å®¹å™¨ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„å‚æ•°ï¼š -dt å¯ä»¥è®©å®¹å™¨ä½¿ç”¨ Daemon çš„æ–¹å¼å¯åŠ¨ä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯ï¼Œå¯ä»¥ä¿è¯å®¹å™¨ä¸€ç›´å­˜æ´»ä¸ä¼š detach åå°±è¢«æ€æ­»ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¤šæ¬¡æ“ä½œï¼›--restart=always å¯ä»¥åœ¨æ¯æ¬¡å¼€æœºæ—¶è‡ªåŠ¨é‡å¯å®¹å™¨ï¼Œå¯ä»¥è§†è‡ªå·±çš„æƒ…å†µå»æ‰æˆ–è€…æ”¹æˆ --restart=unless-stopped ç­‰ï¼›--network=host æŒ‡å®šä¸å®¿ä¸»æœºå™¨ä½¿ç”¨åŒä¸€ä¸ªç½‘ç»œï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹æ–‡æ¡£æˆ–è€…åé¢çš„ç½‘ç»œç»“æ„ã€‚\nè®¾ç½®åå³å¯æ‰“å¼€ç»ˆç«¯ï¼Œä½¿ç”¨ bash run_docker.sh å¯åŠ¨å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ docker exec -it {container_id} bash æ¥è¿æ¥å®¹å™¨è¿›è¡Œæ“ä½œï¼Œå…¶ä¸­ container_id å¯ä»¥é€šè¿‡ docker ps æˆ–è€…ä¸Šè¿°è„šæœ¬çš„è¿”å›å€¼æŸ¥çœ‹ã€‚\nè¿›å…¥åå¯ä½¿ç”¨ nvidia-smi éªŒè¯ä¸€ä¸‹ï¼Œå‡ºç°ä¸‹æ–¹çš„ä¿¡æ¯å³ä»£è¡¨æˆåŠŸï¼š\nç¯å¢ƒé…ç½®åˆ°æ­¤ç»“æŸï¼Œç»ˆäºå¯ä»¥å¼€å§‹è®­ç»ƒå’Œéƒ¨ç½²ç½‘ç»œäº†ã€‚\nè®­ç»ƒ COCO æ•°æ®é›†å¹¶è¿›è¡Œéƒ¨ç½² æ•°æ®å‡†å¤‡ ä¸‹æ–¹çš„æ“ä½œå‡åœ¨ä¸Šæ–¹å¯åŠ¨çš„å®¹å™¨ä¸­è¿›è¡Œï¼Œé¦–å…ˆéœ€è¦å…ˆ docker exec è¿›å…¥å®¹å™¨ä¸­ã€‚\nå…¶ä¸­å‡†å¤‡ COCO æ•°æ®é›†éƒ¨åˆ†å‚è€ƒ å®˜æ–¹æ–‡æ¡£éƒ¨åˆ†ï¼Œé¦–å…ˆè¿›å…¥ /data ç›®å½•ï¼Œç„¶åæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ mscocoï¼Œä¸‹è½½æ•°æ®é›†ã€è§£å‹å³å¯ã€‚\n# è¿›å…¥ä¹‹å‰æŒ‚è½½çš„ /data ç›®å½• cd /data # åˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜å‚¨æ•°æ®é›† mkdir mscoco # ä¸‹è½½ train2017.zipï¼Œå³è®­ç»ƒæ•°æ®é›† wget -c http://images.cocodataset.org/zips/train2017.zip # ä¸‹è½½ val2017.zipï¼Œå³éªŒè¯æ•°æ®é›† wget -c http://images.cocodataset.org/zips/val2017.zip # ä¸‹è½½ annotations_trainval2017.zip å³å¯¹åº”æ ‡ç­¾ wget -c http://images.cocodataset.org/annotations/annotations_trainval2017.zip # è§£å‹ unzip train2017.zip unzip val2017.zip unzip annotations_trainval2017.zip éšåè¿›å…¥ /open_explorer/horizon_model_train_samples ç›®å½•ï¼Œå¦‚æœè¿™é‡Œä½ å’Œæˆ‘ä¹‹å‰ä¸€æ ·æ˜¯æŒ‚è½½çš„æ•´ä¸ª OE åŒ…ï¼Œé‚£è¿™ä¸ªè·¯å¾„å¯èƒ½ä¼šé•¿ä¸€äº›ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œæ˜¯ /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samplesã€‚\nå°†æ•°æ®é›†æ‰“åŒ…æˆ lmdb æ ¼å¼ï¼Œæ³¨æ„ä¸‹æ–¹çš„ /data/mscoco è·¯å¾„æ˜¯æˆ‘ä»¬ä¹‹å‰å­˜æ”¾æ•°æ®é›†çš„è·¯å¾„ï¼š\n# è½¬æ¢è®­ç»ƒé›† python3 tools/datasets/mscoco_packer.py --src-data-dir /data/mscoco/ --target-data-dir /data/mscoco --split-name train --pack-type lmdb # è½¬æ¢éªŒè¯é›† python3 tools/datasets/mscoco_packer.py --src-data-dir /data/mscoco/ --target-data-dir /data/mscoco --split-name val --pack-type lmdb è¿è¡Œå®Œå³æ‰“åŒ…æˆåŠŸï¼Œ/data/mscoco ç›®å½•ä¸‹ä¼šå¤šå‡ºæ¥ train_lmdb å’Œ val_lmdb ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œå³æ‰“åŒ…ä¹‹åçš„è®­ç»ƒæ•°æ®é›†å’ŒéªŒè¯æ•°æ®é›†ï¼Œä¹Ÿæ˜¯ç½‘ç»œæœ€ç»ˆè¯»å–çš„æ•°æ®é›†ã€‚\nä¿®æ”¹é…ç½®æ–‡ä»¶ åœ°å¹³çº¿æä¾›çš„ HAT å·¥å…·é“¾æ˜¯ä¸€ä¸ªç±» mmdetion çš„ä¸œè¥¿ï¼Œæ¨¡å‹å®šä¹‰ã€è®­ç»ƒã€éªŒè¯éƒ½æµç¨‹éƒ½å®šä¹‰åœ¨ä¸€ä¸ª config.py æ–‡ä»¶ä¸­ï¼Œå®˜æ–¹æä¾›çš„æ‰€æœ‰é…ç½®æ–‡ä»¶å¯ä»¥åœ¨ configs ç›®å½•ä¸‹æ‰¾åˆ°ï¼ŒFCOS å¯¹åº”çš„å°±æ˜¯ configs/detection/fcos ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬è¿™é‡Œåªè€ƒè™‘ fcos_efficientnetb0_mscoco.py ï¼Œå…³äºé…ç½®çš„è¿›ä¸€æ­¥è®²è§£ï¼Œå¯è§å®˜æ–¹æ–‡æ¡£ï¼šconfig æ–‡ä»¶ä»‹ç»ã€‚\nåœ¨ä¿®æ”¹ä¹‹å‰ï¼Œæœ€å¥½å…ˆå¤‡ä»½ä¸€ä¸‹åŸä»¶ï¼Œå¯ä»¥ä½œä¸ºå¯¹æ¯”ï¼Œä¹Ÿæ–¹ä¾¿å›æº¯ï¼š\ncp fcos_efficientnetb0_mscoco.py fcos_efficientnetb0_mscoco_back.py è¦æ”¹çš„ç‚¹æœ‰ä¸‰ä¸ªï¼š\ndevice_idsï¼šè¿™é‡Œä»£è¡¨çš„æ˜¯ä½ ä½¿ç”¨çš„ GPU åºå·ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ª GPU å°±åªä¿ç•™ [0]ï¼Œä¸¤ä¸ªå°±æ˜¯ [0, 1]ï¼Œä»¥æ­¤ç±»æ¨ã€‚ æ‰€æœ‰è·Ÿ ./tmp_data æœ‰å…³çš„ä½ç½®ï¼Œè¿™é‡Œç›¸å…³çš„éƒ½æ˜¯æŒ‡å®šçš„æ•°æ®é›†ä½ç½®ï¼Œå®˜æ–¹ä¸¾ä¾‹æ˜¯å°†æ•°æ®é›†éƒ½æ”¾åœ¨äº†åŒ configs åŒç›®å½•çš„ tmp_data ç›®å½•ï¼Œä½†æ˜¯æˆ‘ä»¬æ”¾åœ¨äº† /data ç›®å½•ï¼Œå› æ­¤è¦å°†æ‰€æœ‰çš„ ./tmp_data éƒ½æ”¹æˆ /data float_trainerï¼šè¿™ä¸ªå‚æ•°æ˜¯ä¸ª Dictï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ª num_epochs ï¼Œä»£è¡¨æˆ‘ä»¬è®­ç»ƒå¤šå°‘è½®ï¼Œè¿™é‡Œé»˜è®¤æ˜¯ 300ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚è°ƒæ•´ï¼Œä¾‹å¦‚ 5ã€10ã€100 ç­‰ã€‚ å¼€å§‹è®­ç»ƒï¼ è®­ç»ƒå¾ˆç®€å•ï¼Œä¸€è¡Œå‘½ä»¤å³å¯ï¼š\n# è¿›å…¥ horizon_model_train_samples ç›®å½• cd /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples # å¼€å§‹è®­ç»ƒ python3 tools/train.py --step float --config configs/detection/fcos/fcos_efficientnetb0_mscoco.py å¦‚æœä¸å‡ºæ„å¤–ï¼Œå·²ç»å¼€å§‹è®­ç»ƒäº†ï¼Œæ­£å¸¸å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\né¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™é‡Œæ¨èé…åˆ tmux å·¥å…·æ¥è®­ç»ƒï¼Œå¯ä»¥è®© session åœ¨åå°è¿è¡Œï¼Œé˜²æ­¢æ„å¤–ä¸­æ–­ï¼Œé¡ºé™„ä¸€ä¸ª tmux æ•™ç¨‹ï¼šTmux ä½¿ç”¨æ•™ç¨‹ã€‚\næ¨¡å‹è½¬æ¢ è®­ç»ƒçš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œä¸»è¦å–å†³äºæ•°æ®é›†çš„å¤§å°ï¼Œå¦‚æœæ˜¯ mscoco è¿™ç§å¤§å‹æ•°æ®é›†ï¼Œä¸€ä¸ª epoch å°±è¦å¥½ä¹…æ‰è¡Œã€‚\nè¿™é‡Œæˆ‘è®­ç»ƒäº†åè½®å°±ç»“æŸäº†ï¼Œéšåè¿›å…¥ tmp_models ç›®å½•ï¼Œæ‰¾åˆ°æˆ‘ä»¬è®­ç»ƒå¥½çš„æƒé‡æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼Œè¿™é‡Œçš„å­˜æ”¾ä½ç½®ä¸»è¦å’Œé…ç½®æ–‡ä»¶ä¸­çš„ task_name ä¸ ckpt_dir æœ‰å…³ï¼Œå¯ä»¥æŒ‰éœ€ä¿®æ”¹ï¼š\næ¥ä¸‹æ¥å°±æ˜¯å°†æƒé‡æ–‡ä»¶å¯¼å‡ºæˆ ONNX æ¨¡å‹ï¼š\npython3 tools/export_onnx.py --config configs/detection/fcos/fcos_efficientnetb0_mscoco.py --ckpt tmp_models/fcos_efficientnetb0_mscoco/float-checkpoint-best.pth.tar --onnx-name fcos.onnx å¦‚ä¸Šå‘½ä»¤ï¼Œå°†è®­ç»ƒå¾—åˆ°çš„ best æƒé‡æ–‡ä»¶ï¼ˆfloat-checkpoint-best.pth.tarï¼‰å¯¼å‡ºæˆäº† fcos.onnx æ¨¡å‹æ–‡ä»¶ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„æƒé‡ï¼ŒæŒ‡å®šå¯¹æ¨¡å‹è·¯å¾„å³å¯ã€‚\næ¥ä¸‹æ¥æ˜¯ä½¿ç”¨åœ°å¹³çº¿çš„å·¥å…·é“¾å¯¹ ONNX æ¨¡å‹è¿›è¡Œé‡åŒ–ï¼Œä»¥ä¾¿æˆ‘ä»¬åé¢ä¸Šæ¿æ¨ç†ï¼š\nç¬¬ä¸€æ­¥ï¼Œå…ˆç§»åŠ¨ä¸€ä¸‹å¾—åˆ°çš„æƒé‡æ–‡ä»¶ï¼Œæ–¹ä¾¿åé¢çš„æŸ¥æ‰¾ï¼š\n# è¿›å…¥ horizon_model_train_samples ç›®å½• cd /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples # å»ºç«‹æ–‡ä»¶å¤¹ mkdir -p ../horizon_model_convert_sample/08_customs # ç§»åŠ¨ onnx æ¨¡å‹è¿‡å» cp ./fcos.onnx ../horizon_model_convert_sample/08_customs æ¥ä¸‹æ¥å°±æ˜¯é‚£å¥—æ ‡å‡†çš„è½¬æ¢æµç¨‹ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ•™ç¨‹ï¼š6.3 å¿«é€Ÿä½“éªŒï¼Œè¿˜æœ‰å¤§ä½¬çš„æŒ‡å—ï¼šä¸€æ–‡å¸¦ä½ è½»æ¾èµ°å‡ºæ¨¡å‹éƒ¨ç½²æ–°æ‰‹æ‘ã€‚\nä¸»è¦æ˜¯æ¶‰åŠæ¨¡å‹åœ°å€å’Œæ•°æ®é›†åœ°å€çš„æ—¶å€™éœ€è¦æ”¹æˆæˆ‘ä»¬å¯¹åº”çš„å³å¯ï¼Œå…¶ä»–çš„éƒ½é»˜è®¤å°±è¡Œï¼Œæ¥ä¸‹æ¥ç»™å‡ºæˆ‘çš„å‡ ä¸ªè„šæœ¬åŠç²¾ç®€åçš„è½¬æ¢é…ç½®æ–‡ä»¶ï¼š\n01_check.sh # 01_check.sh set -e -v cd $(dirname $0) model_type=\"onnx\" onnx_model=\"../../../08_customs/fcos.onnx\" march=\"bernoulli2\" hb_mapper checker --model-type ${model_type} \\ --model ${onnx_model} \\ --march ${march} 02_preprocess.sh # 02_preprocess.sh set -e -v cd $(dirname $0) || exit python3 ../../../data_preprocess.py \\ --src_dir /data/mscoco/train2017 \\ --dst_dir ./calibration_data_yuv_f32 \\ --cal_img_num 50 \\ --pic_ext .yuv \\ --read_mode opencv \\ --saved_data_type float32 fcos_efficientnetb0_config.yaml # fcos_efficientnetb0_config.yaml model_parameters: onnx_model: '../../../08_customs/fcos.onnx' march: \"bernoulli2\" layer_out_dump: False working_dir: 'fcos_test' output_model_file_prefix: 'fcos_test' input_parameters: input_name: \"\" input_type_rt: 'nv12' input_type_train: 'yuv444' input_layout_train: 'NCHW' input_shape: '' norm_type: 'data_mean_and_scale' mean_value: 128.0 scale_value: 0.0078125 calibration_parameters: cal_data_dir: './calibration_data_yuv_f32_qyun' cal_data_type: 'float32' calibration_type: 'max' max_percentile: 0.99996 compiler_parameters: compile_mode: 'latency' debug: False optimize_level: 'O3' è¿™é‡Œç†è®ºä¸Šåªéœ€è¦æ‰§è¡Œå®Œ 03_build.sh è„šæœ¬è½¬æ¢å³ç»“æŸï¼Œä¸å‡ºæ„å¤–åœ¨åŒç›®å½•ä¸‹ä¼šç”Ÿæˆ fcos_test ç›®å½•ï¼Œå·²ç»åœ¨å…¶ä¸­å¯æ‰¾åˆ° fcos.bin ï¼Œè¿™å³æ˜¯æˆ‘ä»¬åç»­ä¸Šæ¿æ¨ç†éœ€è¦çš„æ¨¡å‹æ–‡ä»¶ã€‚\næ¨¡å‹æ¨ç† è¿™é‡Œ Python æ¨ç†æˆ‘å‚è€ƒäº† X3M æ¿å­ä¸Š /app/ai_inference/02_usb_camera_sample/usb_camera_fcos.py ç›®å½•ä¸‹çš„æ¨ç†è„šæœ¬ï¼Œç›´æ¥ä¸Šä»£ç ï¼š\n#!/usr/bin/env python3 import os from hobot_dnn import pyeasy_dnn as dnn from hobot_vio import libsrcampy as srcampy import numpy as np import cv2 import colorsys from time import time # detection model class names def get_classes(): return np.array([\"person\", \"bicycle\", \"car\", \"motorcycle\", \"airplane\", \"bus\", \"train\", \"truck\", \"boat\", \"traffic light\", \"fire hydrant\", \"stop sign\", \"parking meter\", \"bench\", \"bird\", \"cat\", \"dog\", \"horse\", \"sheep\", \"cow\", \"elephant\", \"bear\", \"zebra\", \"giraffe\", \"backpack\", \"umbrella\", \"handbag\", \"tie\", \"suitcase\", \"frisbee\", \"skis\", \"snowboard\", \"sports ball\", \"kite\", \"baseball bat\", \"baseball glove\", \"skateboard\", \"surfboard\", \"tennis racket\", \"bottle\", \"wine glass\", \"cup\", \"fork\", \"knife\", \"spoon\", \"bowl\", \"banana\", \"apple\", \"sandwich\", \"orange\", \"broccoli\", \"carrot\", \"hot dog\", \"pizza\", \"donut\", \"cake\", \"chair\", \"couch\", \"potted plant\", \"bed\", \"dining table\", \"toilet\", \"tv\", \"laptop\", \"mouse\", \"remote\", \"keyboard\", \"cell phone\", \"microwave\", \"oven\", \"toaster\", \"sink\", \"refrigerator\", \"book\", \"clock\", \"vase\", \"scissors\", \"teddy bear\", \"hair drier\", \"toothbrush\"]) # return np.array([\"tissue\", \"sock\", \"shoe\", \"cable\", \"bin\"]) # bgræ ¼å¼å›¾ç‰‡è½¬æ¢æˆ NV12æ ¼å¼ def bgr2nv12_opencv(image): height, width = image.shape[0], image.shape[1] area = height * width yuv420p = cv2.cvtColor( image, cv2.COLOR_BGR2YUV_I420).reshape((area * 3 // 2,)) y = yuv420p[:area] uv_planar = yuv420p[area:].reshape((2, area // 4)) uv_packed = uv_planar.transpose((1, 0)).reshape((area // 2,)) nv12 = np.zeros_like(yuv420p) nv12[:height * width] = y nv12[height * width:] = uv_packed return nv12 def postprocess(model_output, model_hw_shape, origin_image=None, origin_img_shape=None, score_threshold=0.5, nms_threshold=0.6, dump_image=False): input_height = model_hw_shape[0] input_width = model_hw_shape[1] if origin_image is not None: origin_image_shape = origin_image.shape[0:2] else: origin_image_shape = origin_img_shape prediction_bbox = decode(outputs=model_output, score_threshold=score_threshold, origin_shape=origin_image_shape, input_size=512) prediction_bbox = nms(prediction_bbox, iou_threshold=nms_threshold) prediction_bbox = np.array(prediction_bbox) topk = min(prediction_bbox.shape[0], 1000) if topk != 0: idx = np.argpartition(prediction_bbox[..., 4], -topk)[-topk:] prediction_bbox = prediction_bbox[idx] if dump_image and origin_image is not None: draw_bboxs(origin_image, prediction_bbox) return prediction_bbox def draw_bboxs(image, bboxes, gt_classes_index=None, classes=get_classes()): \"\"\"draw the bboxes in the original image \"\"\" num_classes = len(classes) image_h, image_w, channel = image.shape hsv_tuples = [(1.0 * x / num_classes, 1., 1.) for x in range(num_classes)] colors = list(map(lambda x: colorsys.hsv_to_rgb(*x), hsv_tuples)) colors = list( map(lambda x: (int(x[0] * 255), int(x[1] * 255), int(x[2] * 255)), colors)) fontScale = 0.5 bbox_thick = int(0.6 * (image_h + image_w) / 600) for i, bbox in enumerate(bboxes): coor = np.array(bbox[:4], dtype=np.int32) if gt_classes_index == None: class_index = int(bbox[5]) score = bbox[4] else: class_index = gt_classes_index[i] score = 1 bbox_color = colors[class_index] c1, c2 = (coor[0], coor[1]), (coor[2], coor[3]) cv2.rectangle(image, c1, c2, bbox_color, bbox_thick) classes_name = classes[class_index] bbox_mess = '%s: %.2f' % (classes_name, score) t_size = cv2.getTextSize(bbox_mess, 0, fontScale, thickness=bbox_thick // 2)[0] cv2.rectangle(image, c1, (c1[0] + t_size[0], c1[1] - t_size[1] - 3), bbox_color, -1) cv2.putText(image, bbox_mess, (c1[0], c1[1] - 2), cv2.FONT_HERSHEY_SIMPLEX, fontScale, (0, 0, 0), bbox_thick // 2, lineType=cv2.LINE_AA) print(\"{} is in the picture with confidence:{:.4f}\".format( classes_name, score)) # cv2.imwrite(\"demo.jpg\", image) return image def decode(outputs, score_threshold, origin_shape, input_size=512): def _distance2bbox(points, distance): x1 = points[..., 0] - distance[..., 0] y1 = points[..., 1] - distance[..., 1] x2 = points[..., 0] + distance[..., 2] y2 = points[..., 1] + distance[..., 3] return np.stack([x1, y1, x2, y2], -1) def _scores(cls, ce): cls = 1 / (1 + np.exp(-cls)) ce = 1 / (1 + np.exp(-ce)) return np.sqrt(ce * cls) def _bbox(bbox, stride, origin_shape, input_size): # l t r b | h, w = t, r h, w = bbox.shape[1:3] yv, xv = np.meshgrid(np.arange(h), np.arange(w)) xy = (np.stack((yv, xv), 2) + 0.5) * stride bbox = _distance2bbox(xy, bbox) # opencv read, shape[1] is w, shape[0] is h scale_w = origin_shape[1] / input_size scale_h = origin_shape[0] / input_size scale = max(origin_shape[0], origin_shape[1]) / input_size # origin img is pad resized # bbox = bbox * scale # origin img is resized bbox = bbox * [scale_w, scale_h, scale_w, scale_h] return bbox bboxes = list() strides = [8, 16, 32, 64, 128] # å„ä¸ª stride æ‰¾ç¬¦åˆçš„æ¨¡å‹ for i in range(len(strides)): cls = outputs[i].buffer bbox = outputs[i + 5].buffer ce = outputs[i + 10].buffer scores = _scores(cls, ce) classes = np.argmax(scores, axis=-1) classes = np.reshape(classes, [-1, 1]) max_score = np.max(scores, axis=-1) max_score = np.reshape(max_score, [-1, 1]) bbox = _bbox(bbox, strides[i], origin_shape, input_size) bbox = np.reshape(bbox, [-1, 4]) pred_bbox = np.concatenate([bbox, max_score, classes], axis=1) index = pred_bbox[..., 4] \u003e score_threshold pred_bbox = pred_bbox[index] bboxes.append(pred_bbox) return np.concatenate(bboxes) def nms(bboxes, iou_threshold, sigma=0.3, method='nms'): def bboxes_iou(boxes1, boxes2): boxes1 = np.array(boxes1) boxes2 = np.array(boxes2) boxes1_area = (boxes1[..., 2] - boxes1[..., 0]) * \\ (boxes1[..., 3] - boxes1[..., 1]) boxes2_area = (boxes2[..., 2] - boxes2[..., 0]) * \\ (boxes2[..., 3] - boxes2[..., 1]) left_up = np.maximum(boxes1[..., :2], boxes2[..., :2]) right_down = np.minimum(boxes1[..., 2:], boxes2[..., 2:]) inter_section = np.maximum(right_down - left_up, 0.0) inter_area = inter_section[..., 0] * inter_section[..., 1] union_area = boxes1_area + boxes2_area - inter_area ious = np.maximum(1.0 * inter_area / union_area, np.finfo(np.float32).eps) return ious classes_in_img = list(set(bboxes[:, 5])) best_bboxes = [] for cls in classes_in_img: cls_mask = (bboxes[:, 5] == cls) cls_bboxes = bboxes[cls_mask] while len(cls_bboxes) \u003e 0: max_ind = np.argmax(cls_bboxes[:, 4]) best_bbox = cls_bboxes[max_ind] best_bboxes.append(best_bbox) cls_bboxes = np.concatenate( [cls_bboxes[:max_ind], cls_bboxes[max_ind + 1:]]) iou = bboxes_iou(best_bbox[np.newaxis, :4], cls_bboxes[:, :4]) weight = np.ones((len(iou),), dtype=np.float32) assert method in ['nms', 'soft-nms'] if method == 'nms': iou_mask = iou \u003e iou_threshold weight[iou_mask] = 0.0 if method == 'soft-nms': weight = np.exp(-(1.0 * iou ** 2 / sigma)) cls_bboxes[:, 4] = cls_bboxes[:, 4] * weight score_mask = cls_bboxes[:, 4] \u003e 0. cls_bboxes = cls_bboxes[score_mask] return best_bboxes def print_properties(pro): print(\"tensor type:\", pro.tensor_type) print(\"data type:\", pro.dtype) print(\"layout:\", pro.layout) print(\"shape:\", pro.shape) if __name__ == '__main__': models = dnn.load('./models/fcos.bin') # æ‰“å°è¾“å…¥ tensor çš„å±æ€§ print_properties(models[0].inputs[0].properties) # æ‰“å°è¾“å‡º tensor çš„å±æ€§ print(len(models[0].outputs)) for output in models[0].outputs: print_properties(output.properties) frame = cv2.imread(\"./kite.jpg\") if frame is None: print(\"Image is not exist.\") height, width = frame.shape[:2] print(\"height: \", height, \"width: \", width) # æŠŠå›¾ç‰‡ç¼©æ”¾åˆ°æ¨¡å‹çš„è¾“å…¥å°ºå¯¸ # è·å–ç®—æ³•æ¨¡å‹çš„è¾“å…¥tensor çš„å°ºå¯¸ h, w = models[0].inputs[0].properties.shape[2], models[0].inputs[0].properties.shape[3] des_dim = (w, h) resized_data = cv2.resize(frame, des_dim, interpolation=cv2.INTER_AREA) nv12_data = bgr2nv12_opencv(resized_data) # Forward outputs = models[0].forward(nv12_data) # Do post process input_shape = (h, w) prediction_bbox = postprocess( outputs, input_shape, origin_img_shape=(height, width)) if frame.shape[0] != height or frame.shape[1] != width: frame = cv2.resize(frame, (width, height), interpolation=cv2.INTER_AREA) # Draw bboxs box_bgr = draw_bboxs(frame, prediction_bbox) cv2.imwrite(\"kite_with_bbox.jpg\", box_bgr) å…¶å®æµç¨‹è¿˜æ˜¯è›®ç®€å•çš„ï¼Œå°±æ˜¯ åŠ è½½æ¨¡å‹ -\u003e è¯»å–ç…§ç‰‡ -\u003e Resize ç…§ç‰‡åˆ°æ¨¡å‹æ¨ç†å°ºå¯¸ -\u003e è½¬åŒ–ä¸º NV12 è¾“å…¥æ ¼å¼ -\u003e æ‹¿åˆ°è¾“å‡º outputs -\u003e å¯¹æ•°æ®é›†è¿›è¡Œåå¤„ç†å¾—åˆ° bbox ä¸ classes ç­‰æ•°æ® -\u003e Resize ç…§ç‰‡åˆ°åŸå°ºå¯¸ç»˜åˆ¶æ¡† -\u003e å†™ç…§ç‰‡ã€‚\nå¤§å®¶æ‹¿è„šæœ¬æ¨ç†çš„æ—¶å€™ï¼Œåªéœ€è¦æ”¹å˜ models å’Œè¯»å–ç…§ç‰‡çš„ä½ç½®å³å¯ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨çš„ç¤ºä¾‹å›¾ç‰‡æ˜¯åœ¨æ¨¡å‹è½¬åŒ–åæµ‹è¯•æ¨ç†ä½¿ç”¨çš„ï¼Œå¯ä»¥åœ¨ OE åŒ…çš„å¦‚ä¸‹è·¯å¾„æ‰¾åˆ° ai_toolchain/horizon_model_convert_sample/01_common/test_data/det_images/kite.jpgã€‚\næ¥ä¸‹æ¥å°±æ˜¯è¿è¡Œè„šæœ¬è¿›è¡Œæ¨ç†ï¼Œå¾—åˆ°çš„æ¨ç†ç»“æœå¦‚ä¸‹ï¼š\nä¸ºä»€ä¹ˆç»“æœæ˜¯è¿™æ ·çš„ï¼Œèµ·åˆæˆ‘è®¤ä¸ºæ˜¯æˆ‘æ¨ç†è„šæœ¬å†™é”™äº†ï¼Œå› æ­¤æˆ‘ç›´æ¥å°†æƒé‡æ›¿æ¢ä¸ºå®˜æ–¹çš„æƒé‡ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š\nå¾ˆæ˜¾ç„¶ï¼Œè¿™æ¬¡çš„æ¨ç†æ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜ï¼Œè„šæœ¬æ˜¯æ²¡é—®é¢˜ï¼Œåªæ˜¯æƒé‡å‡ºäº†é—®é¢˜ï¼Œå› æ­¤æˆ‘åˆä»”ç»†æ£€æŸ¥äº†è®­ç»ƒå’Œæ¨¡å‹è½¬æ¢çš„å„ä¸ªæ­¥éª¤ï¼Œä½†éƒ½æ²¡æœ‰å‘ç°é—®é¢˜ã€‚åŒæ—¶ï¼Œä½¿ç”¨å®˜æ–¹æä¾›çš„ mapper ç›®å½•ä¸‹åŸ onnx è¿›è¡Œè½¬æ¢åï¼Œä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚é‚£ä¹ˆé—®é¢˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ\næŸ¥æ‰¾é—®é¢˜ å› ä¸ºé€šè¿‡ä¸Šé¢çš„æ’é™¤å¯ä»¥ç¡®å®šï¼Œè½¬åŒ–è¿™ä¸ªè¿‡ç¨‹æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ï¼Œé‚£ä¹Ÿå°±åªèƒ½æ˜¯æ¨¡å‹å®šä¹‰å’Œè®­ç»ƒä¸­å‡ºç°çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸Šé¢çš„æ•ˆæœåˆæ˜æ˜¾ä¸æ˜¯è®­ç»ƒè¿‡æ‹Ÿåˆæˆ–è€…æ¬ æ‹Ÿåˆå¯¼è‡´çš„ï¼Œå› ä¸ºæ¡†çš„ä½ç½®æ˜¯å¤§è‡´å¯¹çš„ï¼Œå°±æ˜¯å¤ªå¤šäº†ï¼Œè€Œä¸”å¤ªå°äº†ï¼Œå› æ­¤æˆ‘æ€€ç–‘æ˜¯æ¨¡å‹ä¸Šå‡ºäº†é—®é¢˜ï¼Œå¯èƒ½æ˜¯æœ‰èŠ‚ç‚¹ä¸ä¸€è‡´ã€‚\nç¡®å®šäº†æ–¹å‘ï¼Œæ¥ä¸‹æ¥æˆ‘é¦–å…ˆå¯¹å®˜æ–¹åŸ onnx æ¨¡å‹æ–‡ä»¶å’Œæˆ‘è‡ªå·±è®­ç»ƒå¾—åˆ°çš„ onnx æ¨¡å‹ä½¿ç”¨äº† 01_checker.sh è„šæœ¬æ¥è¿›è¡Œæ£€æŸ¥ï¼Œå› ä¸ºä»–ä¼šè¾“å‡ºæ¨¡å‹ä¸­çš„å„ä¸ªå±‚ï¼Œå¯¹æ¯”ç»“æœå¦‚ä¸‹ï¼š\nå·¦ä¾§æ˜¯æˆ‘è‡ªå·±è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹ï¼Œå³ä¾§æ˜¯æˆ‘å®˜æ–¹æä¾›çš„æ¨¡å‹ï¼Œå¯ä»¥å‘ç°ï¼Œä¸¤è€…å­˜åœ¨å·®å¼‚ï¼Œå…¶å®å°±æ˜¯å®˜æ–¹æ¨¡å‹ç›¸æ¯”äºè®­ç»ƒå¾—åˆ°çš„æ¨¡å‹ä¼šå¤šäº†å‡ ä¸ª Mul èŠ‚ç‚¹ã€‚\næ¥ä¸‹æ¥è¿›ä¸€æ­¥ä½¿ç”¨ netron å·¥å…·å¯¹ä¸¤ä¸ªæ¨¡å‹è¿›è¡Œå¯¹æ¯”ï¼Œæœ‰åŒºåˆ«çš„å¯¹æ¯”ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå·¦ä¾§ä¸ºè‡ªå·±è®­ç»ƒçš„æ¨¡å‹ï¼Œå³ä¾§ä¸ºå®˜æ–¹æ¨¡å‹ã€‚å¯ä»¥çœ‹åˆ°åªæœ‰ bbox ä¿¡æ¯ï¼ˆå¯¹äº FCOS ä¸ºï¼ˆl, t, r, bï¼‰å››å…ƒç»„ï¼‰åœ¨è¾“å‡ºæ—¶ä¸¤ä¸ªæ¨¡å‹æœ‰åŒºåˆ«ï¼Œå¤šäº†ä¸€æ­¥ Relu æ¿€æ´»å‡½æ•°å’Œ Mul èŠ‚ç‚¹ï¼Œå…¶ä»–çš„ç»è¿‡å¯¹æ¯”æ²¡æœ‰åŒºåˆ«ã€‚\nåŒæ—¶è§‚å¯Ÿå‘ç°ï¼Œè¿™é‡Œ Mul èŠ‚ç‚¹å¯¹åº”çš„æ•°å€¼ï¼Œå…¶å®æ˜¯å¯¹åº”çš„ strideï¼ˆè¿™ä¸ªå¤§å®¶å¯ä»¥ä½¿ç”¨ netron å»çœ‹çœ‹ï¼‰\nçŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œè§£å†³æ–¹æ¡ˆå°±æœ‰äº†ï¼Œåªéœ€è¦æ”¹åŠ¨ä¸‹é¢è¿™ä¸€è¡Œå³å¯ï¼š\n# Decode å‡½æ•°ä¸­è·å–æ•°æ®çš„éƒ¨åˆ† # å„ä¸ª stride æ‰¾ç¬¦åˆçš„æ¨¡å‹ for i in range(len(strides)): cls = outputs[i].buffer bbox = outputs[i + 5].buffer * strides[i] # modified ce = outputs[i + 10].buffer scores = _scores(cls, ce) å¾ˆå¥½ç†è§£ï¼Œå¯¹ bbox è·å¾—çš„åŸå§‹æ•°æ®ä¹˜äº† strides[i]ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰å¤„ç† Relu å‡½æ•°ï¼Œå› ä¸ºå³ä½¿æ˜¯è´Ÿæ•°ï¼ŒOpenCV ç»˜åˆ¶ä¹Ÿæ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ã€‚\nå†æ¬¡è¿è¡Œè·å¾—çš„æ¨ç†å›¾å¦‚ä¸‹ï¼Œè¿™æ¬¡æ­£å¸¸äº†ï¼š\nè‡³æ­¤ï¼Œè®­ç»ƒ mscoco æ•°æ®é›†æ¨¡å‹å¹¶è¿›è¡Œéƒ¨ç½²å°±ç®—ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ¥å¤„ç†è‡ªå·±å¾—åˆ°çš„æ•°æ®é›†ã€‚\nè®­ç»ƒè‡ªé‡‡é›†æ•°æ®é›† å¯¹äºè‡ªé‡‡é›†æ•°æ®é›†ï¼Œæœ€å¯èƒ½æ˜¯æ•°æ®å¤„ç†æ‰“åŒ…ã€ä»¥åŠé…ç½®æ–‡ä»¶çš„é…ç½®è¿™ä¸¤éƒ¨åˆ†å­˜åœ¨é—®é¢˜ï¼Œå‰©ä¸‹çš„æ¨¡å‹æ£€æŸ¥ã€æ ¡å‡†æ•°æ®å‡†å¤‡ã€æ¨¡å‹è½¬åŒ–ã€ä»¥åŠä¸Šæ¿æ¨ç†éƒ¨åˆ†å¯ä»¥è¯´æ˜¯æ ¹æœ¬æ²¡åŒºåˆ«ï¼Œæ‰€ä»¥å°±ç€é‡è®²ä¸€ä¸‹æ•°æ®å‡†å¤‡å’Œé…ç½®éƒ¨åˆ†ã€‚\næ•°æ®å‡†å¤‡ é¦–å…ˆæ•°æ®å‡†å¤‡è¦å‡†å¤‡ COCO JSON æ ¼å¼ï¼Œä»–æ˜¯è·Ÿé€šç”¨ JSON æ ¼å¼ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œè¿™ä¸ªå°±ä¸è¯¦è¿°äº†ã€‚\nç„¶åæ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥å¤ç”¨å®˜æ–¹çš„ mscoco_packer.py è„šæœ¬ï¼Œæˆ‘ä»¬æŠŠæ•°æ®é›†ä¹Ÿå­˜ä¸º train2017ã€val2017 å’Œ annotations ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚å­˜åœ¨æ”¾åœ¨ /data/selfcoco ç›®å½•ä¸‹ï¼Œç±»ä¼¼äºä¸‹é¢ï¼š\n[root@Z690-P selfcoco]# tree . â”œâ”€â”€ annotations â”‚Â â”œâ”€â”€ instances_train2017.json # è®­ç»ƒé›†çš„ label â”‚Â â””â”€â”€ instances_val2017.json # éªŒè¯é›†çš„ label â”œâ”€â”€ train2017 # è®­ç»ƒé›†ç…§ç‰‡ â””â”€â”€ val2017 # éªŒè¯é›†ç…§ç‰‡ è¿™æ—¶å€™å¦‚æœæˆ‘ä»¬æŒ‰ç…§ä¹‹å‰çš„æ“ä½œï¼Œç›´æ¥ä½¿ç”¨ mscoco_packer.py è„šæœ¬è¿›è¡Œæ‰“åŒ…ï¼Œä¼šæŠ¥é”™å¦‚ä¸‹ï¼š\næŠ¥é”™å¤§æ„å°±æ˜¯è®¿é—®äº†å­—å…¸ä¸€ä¸ªä¸å­˜åœ¨çš„é”®ï¼Œç›´æ¥æŸ¥çœ‹æŠ¥é”™çš„ä½ç½®ï¼Œä½äº /usr/local/lib/python3.6/site-packages/hat/data/datasets/mscoco.pyï¼ŒæŸ¥çœ‹åå‘ç° COCO_LABLE_TO_LABLE è¿™ä¸ªå­—å…¸æ˜¯ä¸€ä¸ªç±»åˆ«çš„æ˜ å°„ï¼Œå› ä¸º mscoco æ•°æ®é›†ç±»åˆ«åŒ…å« 80 ç±»ï¼ŒæŒ‰é¡ºåºæ¥æ˜¯ [0, 80)ï¼Œä½†æ˜¯ mscoco æ•°æ®é›†åŸæ•°æ®é›†ç±»åˆ«åºå·èŒƒå›´ä¸º [1, 90]ï¼Œä½†æ˜¯å…¶ä¸­åªæœ‰ 80 ä¸ªç±»åˆ«åºå·ï¼Œæ‰€ä»¥éœ€è¦åšä¸€ä¸ª [1, 90] -\u003e [0, 80) çš„ç±»åˆ«æ˜ å°„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è‡ªåˆ¶çš„æ•°æ®é›†æ²¡æœ‰è¿™ä¸ªç±»åˆ«æ˜ å°„çš„éœ€æ±‚ï¼Œå°±ä¸éœ€è¦æ˜ å°„ï¼ŒæŠŠæ¶‰åŠåˆ°è¿™ä¸ª Dict çš„ä¸¤è¡Œéƒ½å»æ‰å³å¯ã€‚\nBtwï¼šğŸ¤£ è¿™é‡Œçš„ COCO_LABLE_TO_LABLE æ˜¯ä¸æ˜¯æ‹¼é”™äº†ï¼Œè¦æ‹¼ LABEL çš„ï¼Ÿ\n# 229 è¡Œ # anno[0, 4] = COCO_LABLE_TO_LABLE[tar[\"category_id\"]] anno[0, 4] = tar[\"category_id\"] # 327 è¡Œ # np.array([[COCO_LABLE_TO_LABLE[tar[\"category_id\"]]]]) np.array([[tar[\"category_id\"]]]) éšåæ‰“åŒ…å³å¯\n# è½¬æ¢è®­ç»ƒé›† python3 tools/datasets/mscoco_packer.py --src-data-dir /data/selfcoco --target-data-dir /data/selfcoco --split-name train --pack-type lmdb # è½¬æ¢éªŒè¯é›† python3 tools/datasets/mscoco_packer.py --src-data-dir /data/selfcoco --target-data-dir /data/selfcoco --split-name val --pack-type lmdb é…ç½®æ–‡ä»¶ä¿®æ”¹ é…ç½®æ–‡ä»¶é™¤äº†ä¹‹å‰æåˆ°çš„ä¸‰å¤„éœ€è¦ä¿®æ”¹ï¼Œé…ç½®æ–‡ä»¶ä¸­è¿˜éœ€è¦ä¿®æ”¹ä¸ç±»åˆ«ç›¸å…³çš„å‚æ•°ï¼Œå¤§æ¦‚æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š\nnum_classesï¼šè¿™é‡Œå°±æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ç±»åˆ«æ•°ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œæœ‰äº”ç±» [0, 5)ï¼Œé‚£æ”¹ä¸º 5 å³å¯ã€‚ modelï¼šmodel å‚æ•°ä¸­è¿˜æœ‰å¾ˆå¤šæ¶‰åŠåˆ° 80 çš„ï¼Œç»è¿‡æˆ‘æŸ¥çœ‹æºç åï¼Œå‘ç°è¿™äº› 80 çš„ä½ç½®éƒ½åº”è¯¥æ”¹æˆ num_classes å‚æ•°æ‰å¯ä»¥ï¼Œä¾‹å¦‚ model ä¸­çš„ loss_cls å‚æ•°ï¼Œå…¶ä¸­çš„ num_classes å‚æ•°å€¼ 80+1 å°±éœ€è¦æ”¹ä¸º num_classes + 1 ï¼Œpost_process å‚æ•°ä¸­çš„ num_classes å‚æ•°å€¼ 80 ä¹Ÿåº”è¯¥æ”¹ä¸º num_classesï¼Œè¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯å®˜æ–¹çš„ç–å¿½ï¼Œåº”è¯¥æ˜¯å¿˜è®°æ”¹äº†ã€‚ ä¿®æ”¹å®Œåå°±å¯ä»¥æŒ‰ä¹‹å‰çš„æ–¹æ³•è¿›è¡Œè®­ç»ƒäº†ï¼š\n# è¿›å…¥ horizon_model_train_samples ç›®å½• cd /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples # å¼€å§‹è®­ç»ƒ python3 tools/train.py --step float --config configs/detection/fcos/fcos_efficientnetb0_mscoco.py æ ¡å‡†æ•°æ®å‡†å¤‡ è¿™é‡Œé¢„å¤„ç†çš„æ•°æ®ä¹Ÿåº”è¯¥é€‰æ‹©æˆ‘ä»¬è®­ç»ƒçš„æ•°æ®å­é›†ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œå‰©ä¸‹çš„éƒ½ä¸éœ€è¦å˜ï¼š\n# 02_preprocess.sh set -e -v cd $(dirname $0) || exit python3 ../../../data_preprocess.py \\ --src_dir /data/selfcoco/train2017 \\ # é‡è¦ --dst_dir ./calibration_data_yuv_f32 \\ --cal_img_num 50 \\ --pic_ext .yuv \\ --read_mode opencv \\ --saved_data_type float32 æ¨ç†ä»£ç ä¿®æ”¹ è¿™é‡Œéœ€è¦ä¿®æ”¹ get_classes å‡½æ•°è¿”å›çš„ç±»åˆ«åï¼Œæ”¹æˆè‡ªå·±å¯¹åº”çš„ç±»åˆ« List.\næ¨ç†å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œè¯†åˆ«å¯ä»¥æ­£å¸¸çš„å·¥ä½œï¼ˆå› ä¸ºæˆ‘é€‰çš„è®­ç»ƒæ•°æ®é›†æœ‰ç‚¹æï¼Œæ‰€ä»¥è¿‡æ‹Ÿåˆæ¯”è¾ƒä¸¥é‡ï¼Œå°±é€‰äº†ä¸€å¼ å‡‘åˆèƒ½çœ‹çš„å›¾ï¼Œå¤§å®¶è§è°…ï¼‰ã€‚\nåè¨€ è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº† FCOS ç½‘ç»œçš„è®­ç»ƒå’Œéƒ¨ç½²ï¼Œä½†æ˜¯åŸºäº Python çš„æ¨ç†å¯èƒ½æœ‰ç‚¹æ…¢ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒ ai_benchmark ç­‰éƒ¨åˆ†è¿›è¡Œ C++ æ¨ç†ï¼Œä¸»è¦å…³é”®å°±æ˜¯ PostProcess åå¤„ç†éƒ¨åˆ†ï¼Œä¸è¿‡ä¹‹å‰ å¼€å‘è€…ç›´æ’­KEâ€”â€”AIæ¿ç«¯éƒ¨ç½²å®è·µ å¼ è€å¸ˆå·²ç»è®²è¿‡ä¸€éƒ¨åˆ† APIï¼Œå¦‚æœå¤§å®¶æœ‰å…´è¶£ï¼Œæˆ‘åé¢ä¹Ÿå¯ä»¥ç»™å¤§å®¶å‡ºä¸ªå¸–å­è®²è®² ğŸ¤—ã€‚\næ¢ç´¢çš„è¿™å‡ å¤©ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ï¼Œåœ°å¹³çº¿åšäº†å¾ˆå¤šï¼Œå†™äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥å…·ã€åŒ…ï¼Œä½†æ˜¯æ–‡æ¡£è¿˜æ˜¯ä¸å¤Ÿå®Œå–„ï¼Œè€Œä¸”æ–‡æ¡£æœ‰äº›æ··ä¹±ï¼Œç‰ˆæœ¬æ¯”è¾ƒæ··ä¹±ï¼Œä½ç½®æ¯”è¾ƒæ··ä¹±ã€ç­‰ç­‰ï¼Œå®¹æ˜“æ‰¾ä¸åˆ°ã€æ— ä»ä¸‹æ‰‹ç­‰ç­‰ã€‚\nä¾‹å¦‚å¯¹äº FCOS è¿™éƒ¨åˆ†çš„æ–‡æ¡£å°±å¾ˆæ¬ ç¼ºï¼Œå¯¹äº FCOS è®­ç»ƒé…ç½®çš„å„ä¸ªé€‰é¡¹çš„è¯¦è§£ï¼Œå¤§å®¶çœ‹åˆ°æ—¶å€™å¯èƒ½ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¾‹å¦‚ï¼š\nå¦‚ä½•ä½¿ç”¨ CPU è¿›è¡Œè®­ç»ƒè€Œä¸æ˜¯ GPUï¼Ÿ å¦‚ä½•åŸºäºå·²æœ‰çš„æ¨¡å‹è¿›è¡Œè¿ç§»è®­ç»ƒï¼Ÿä¸­æ–­è®­ç»ƒåå¯ä»¥å†ç»§ç»­è¿›è¡Œå—ï¼Ÿ å¯ä»¥ freeze ä¸€éƒ¨åˆ†å‚æ•°è¿›è¡Œ fine-tuning å—ï¼Ÿ è®­ç»ƒæ—¶æœ‰æ•°æ®å¢å¼ºå—ï¼Ÿå¦‚æœä¸éœ€è¦å¯ä»¥å»æ‰å—ï¼Ÿ ä¸è¿‡ç°åœ¨ä¹Ÿæ˜¯åœ¨æ…¢æ…¢å®Œå–„ï¼Œä¸æ–­è¿›æ­¥ï¼Œå¸Œæœ›å¯ä»¥æŠŠè¿™äº›å¥½ç”¨çš„ä¸œè¥¿éƒ½èƒ½è®©å¤§å®¶å¿«ç‚¹æ–¹ä¾¿çš„ç”¨èµ·æ¥ã€‚\næ–‡ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ Github ä»“åº“ ä¸­æ‰¾åˆ°ã€‚\næ–‡ç« åŒæ­¥å‘å¸ƒåœ¨æˆ‘çš„åšå®¢ï¼šhttps://blog.zzsqwq.cn\nå¦‚ä½•ç”¨å·¥å…·é“¾HATè®­ç»ƒfcosè‡ªå®šä¹‰æ•°æ®é›†Â â†©ï¸\nåœ¨OEåŒ…ä¸­è®­ç»ƒfocsæ¨¡å‹Â â†©ï¸\n","wordCount":"1844","inLanguage":"en","datePublished":"2023-02-25T00:45:22+08:00","dateModified":"2023-02-25T00:45:22+08:00","author":{"@type":"Person","name":"zzsqwq"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.zzsqwq.cn/posts/hat-train-fcos/"},"publisher":{"@type":"Organization","name":"Zs's Blog","logo":{"@type":"ImageObject","url":"https://blog.zzsqwq.cn/images/avatar.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.zzsqwq.cn accesskey=h title="Zs's Blog (Alt + H)">Zs's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.zzsqwq.cn/about title=About><span>About</span></a></li><li><a href=https://blog.zzsqwq.cn/posts title=Posts><span>Posts</span></a></li><li><a href=https://blog.zzsqwq.cn/friends title=Friends><span>Friends</span></a></li><li><a href=https://blog.zzsqwq.cn/contact title=Contact><span>Contact</span></a></li><li><a href=https://blog.zzsqwq.cn/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.zzsqwq.cn>Home</a>&nbsp;Â»&nbsp;<a href=https://blog.zzsqwq.cn/posts/>Posts</a></div><h1 class=post-title>åŸºäºåœ°å¹³çº¿ HAT è®­ç»ƒä¸éƒ¨ç½² FCOS å…¨æµç¨‹</h1><div class=post-meta><span title='2023-02-25 00:45:22 +0800 +0800'>February 25, 2023</span>&nbsp;Â·&nbsp;9 min&nbsp;Â·&nbsp;zzsqwq&nbsp;|&nbsp;<a href=https://github.com/zzsqwq/zzsqwq.github.io/tree/master/content/posts/hat-train-fcos.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=å‰è¨€>å‰è¨€</a></li><li><a href=#%e8%ae%ad%e7%bb%83%e7%9a%84%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae aria-label=è®­ç»ƒçš„ç¯å¢ƒé…ç½®>è®­ç»ƒçš„ç¯å¢ƒé…ç½®</a></li><li><a href=#%e8%ae%ad%e7%bb%83-coco-%e6%95%b0%e6%8d%ae%e9%9b%86%e5%b9%b6%e8%bf%9b%e8%a1%8c%e9%83%a8%e7%bd%b2 aria-label="è®­ç»ƒ COCO æ•°æ®é›†å¹¶è¿›è¡Œéƒ¨ç½²">è®­ç»ƒ COCO æ•°æ®é›†å¹¶è¿›è¡Œéƒ¨ç½²</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87 aria-label=æ•°æ®å‡†å¤‡>æ•°æ®å‡†å¤‡</a></li><li><a href=#%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label=ä¿®æ”¹é…ç½®æ–‡ä»¶>ä¿®æ”¹é…ç½®æ–‡ä»¶</a></li><li><a href=#%e5%bc%80%e5%a7%8b%e8%ae%ad%e7%bb%83 aria-label=å¼€å§‹è®­ç»ƒï¼>å¼€å§‹è®­ç»ƒï¼</a></li><li><a href=#%e6%a8%a1%e5%9e%8b%e8%bd%ac%e6%8d%a2 aria-label=æ¨¡å‹è½¬æ¢>æ¨¡å‹è½¬æ¢</a></li><li><a href=#%e6%a8%a1%e5%9e%8b%e6%8e%a8%e7%90%86 aria-label=æ¨¡å‹æ¨ç†>æ¨¡å‹æ¨ç†</a></li><li><a href=#%e6%9f%a5%e6%89%be%e9%97%ae%e9%a2%98 aria-label=æŸ¥æ‰¾é—®é¢˜>æŸ¥æ‰¾é—®é¢˜</a></li></ul></li><li><a href=#%e8%ae%ad%e7%bb%83%e8%87%aa%e9%87%87%e9%9b%86%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=è®­ç»ƒè‡ªé‡‡é›†æ•°æ®é›†>è®­ç»ƒè‡ªé‡‡é›†æ•°æ®é›†</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87-1 aria-label=æ•°æ®å‡†å¤‡>æ•°æ®å‡†å¤‡</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e4%bf%ae%e6%94%b9 aria-label=é…ç½®æ–‡ä»¶ä¿®æ”¹>é…ç½®æ–‡ä»¶ä¿®æ”¹</a></li><li><a href=#%e6%a0%a1%e5%87%86%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87 aria-label=æ ¡å‡†æ•°æ®å‡†å¤‡>æ ¡å‡†æ•°æ®å‡†å¤‡</a></li><li><a href=#%e6%8e%a8%e7%90%86%e4%bb%a3%e7%a0%81%e4%bf%ae%e6%94%b9 aria-label=æ¨ç†ä»£ç ä¿®æ”¹>æ¨ç†ä»£ç ä¿®æ”¹</a></li></ul></li><li><a href=#%e5%90%8e%e8%a8%80 aria-label=åè¨€>åè¨€</a></li></ul></div></details></div><div class=post-content><h2 id=å‰è¨€>å‰è¨€<a hidden class=anchor aria-hidden=true href=#å‰è¨€>#</a></h2><p>æœ€è¿‘æƒ³è¦ä½¿ç”¨è‡ªå·±é‡‡é›†ä¸æ ‡æ³¨çš„æ•°æ®é›†æ¥è®­ç»ƒä¸éƒ¨ç½²ä¸€ä¸‹åœ°å¹³çº¿å¾®è°ƒè¿‡çš„ FCOS ç½‘ç»œï¼Œåœ¨è¯¢é—®å’ŒæŸ¥çœ‹æ–‡æ¡£åå‘ç°å¦‚æœæƒ³åŸºäºå®˜æ–¹å¾®è°ƒçš„æ¨¡å‹è®­ç»ƒï¼Œéœ€è¦ä½¿ç”¨æä¾› HATï¼ˆHorizon Algorithm Toolkitï¼Œæµ·å›¾ï¼‰ æ¥è¿›è¡Œï¼Œå…·ä½“çš„æ–‡æ¡£å¯ä»¥æŸ¥çœ‹ï¼š<a href=https://developer.horizon.ai/api/v1/fileData/doc/ddk_doc/navigation/ai_toolchain/docs_cn/horizon_algorithm_toolkit/index.html>Horizon Algorithm Toolkit æ–‡æ¡£</a>ï¼Œè¿™æ˜¯åœ¨çº¿çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å¯èƒ½ä¼šæ¯”è¾ƒæ—§ï¼Œæƒ³çœ‹æœ€æ–°ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ç¦»çº¿çš„ç‰ˆæœ¬ï¼Œä½ç½®åœ¨ OEï¼ˆOpen Explorerï¼Œå¤©å·¥å¼€ç‰©ï¼‰ åŒ…çš„ doc ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/doc_position.png alt=image-20230224155005117></p><p>æƒ³è¦æ–¹ä¾¿çš„æŸ¥çœ‹ç¦»çº¿æ–‡æ¡£å¯ä»¥é€šè¿‡ Python æ¥å®ç°ï¼Œåœ¨ doc ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>python3</span> <span class=o>-</span><span class=n>m</span> <span class=n>http</span><span class=o>.</span><span class=n>server</span> <span class=mi>3000</span>
</span></span></code></pre></div><p>è¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°çš„ <code>0.0.0.0:3000</code> åœ°å€å¼€å¯ä¸€ä¸ª http serverï¼Œéšåå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä½¿ç”¨ <code>localhost:3000</code> æˆ–è€…å…¶ä»–ç”µè„‘æµè§ˆå™¨ä½¿ç”¨ <code>{ip}:3000</code> æ¥è®¿é—®æ–‡æ¡£ã€‚</p><p>ä½†æ˜¯æŸ¥çœ‹ <a href=https://developer.horizon.ai/api/v1/fileData/doc/ddk_doc/navigation/ai_toolchain/docs_cn/horizon_algorithm_toolkit/examples/fcos.html>æ–‡æ¡£</a> è¿‡åä¼šå‘ç°ï¼Œæ–‡æ¡£å…¶å®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆçš„å…¨é¢ï¼Œè®²çš„æ¯”è¾ƒç®€å•ï¼Œå°è¯•äº†ä¸€ä¸‹ä¸­é—´å‘è¿˜æŒºå¤šçš„ï¼Œç¤¾åŒºé‡Œé¢å…³äºè¿™æ–¹é¢çš„å¸–å­ä¹Ÿä¸å¤š<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>ï¼Œå› æ­¤æƒ³è®°å½•ä¸‹æˆ‘å°è¯•çš„å…¨æµç¨‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå¯¹ä¸Šé¢æ•™ç¨‹æ–‡æ¡£çš„è¡¥å……ã€‚</p><p>ä¸‹é¢ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ol><li><p>è®­ç»ƒçš„ç¯å¢ƒé…ç½®ã€‚</p></li><li><p>å¦‚ä½•åŸºäºå®˜æ–¹çš„ COCO æ•°æ®é›†è®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡åŸºäº mscoco å‘å¸ƒçš„åŒ…å« 80 ç±»çš„<a href=https://cocodataset.org/>æ•°æ®é›†</a>ã€‚</p></li><li><p>å¦‚ä½•åŸºäºè‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Ÿè¿™é‡Œå°±æ˜¯æŒ‡è‡ªå·±å»ºç«‹çš„ï¼Œè‡ªå®šä¹‰ç±»åˆ«çš„ï¼Œå¯èƒ½åªæœ‰å››äº”ç±»ï¼Œæ²¡æœ‰ 80 ç±»çš„æ•°æ®é›†ã€‚</p></li></ol><p>ä¸‹æ–¹æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ <a href=https://github.com/zzsqwq/fcos_tutorial>Github ä»“åº“</a> ä¸­æ‰¾åˆ°ã€‚</p><h2 id=è®­ç»ƒçš„ç¯å¢ƒé…ç½®>è®­ç»ƒçš„ç¯å¢ƒé…ç½®<a hidden class=anchor aria-hidden=true href=#è®­ç»ƒçš„ç¯å¢ƒé…ç½®>#</a></h2><p>æˆ‘è‡ªå·±ç¯å¢ƒé…ç½®å¦‚ä¸‹ï¼š</p><blockquote><p>OS: Ubuntu 20.04</p><p>Docker: 20.10.23</p><p>Nvidia Docker: 2.11.0-1</p><p>GPU: RTX3090</p><p>NVIDIA Driver Version: 515.65.01</p><p>CUDA Version: 11.7</p><p>OE Version: v2.4.2( gcc-9.3.0 For XJ3 )</p></blockquote><p>å› ä¸ºæˆ‘çš„å¼€å‘æ˜¯åŸºäº Ubuntu è¿›è¡Œï¼Œè®­ç»ƒæ˜¯ GPU è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡ŒåªæåŠå…³äº Ubuntu + GPU è®­ç»ƒçš„ç¯å¢ƒé…ç½®ï¼ŒWindows æƒ…å†µä¸‹ï¼Œæˆ–è€…åªæœ‰ CPU çš„æƒ…å†µï¼Œæˆ‘ä¹Ÿæ²¡å°è¯•è¿‡ã€‚</p><p>é¦–å…ˆéœ€è¦å®‰è£… Docker ä»¥åŠ NVIDIA Dockerï¼Œå‰è€…å®‰è£…å‚è€ƒï¼š<a href=https://docs.docker.com/engine/install/ubuntu/>Docker å®‰è£…æ–‡æ¡£</a>ï¼Œåè€…å®‰è£…å‚è€ƒï¼š<a href=https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#install-guide>NVIDIA Docker å®‰è£…æ–‡æ¡£</a>ã€‚</p><p>å‚è€ƒå®˜æ–¹ X3 èŠ¯ç‰‡æ–‡æ¡£ç¼–å†™å¯åŠ¨è„šæœ¬ <code>run_docker.sh</code> å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>export</span> <span class=nv>version</span><span class=o>=</span>v2.4.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ai_toolchain_package_path</span><span class=o>=</span>/data/sunrise/horizon_oe_v2.4.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>dataset_path</span><span class=o>=</span>/data/datasets
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker run -dt --runtime<span class=o>=</span>nvidia -e <span class=nv>NVIDIA_DRIVER_CAPABILITIES</span><span class=o>=</span>compute,utility <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -e <span class=nv>NVIDIA_VISIBLE_DEVICES</span><span class=o>=</span>all --shm-size<span class=o>=</span><span class=s2>&#34;15g&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   --restart<span class=o>=</span>always --network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v <span class=s2>&#34;</span><span class=nv>$ai_toolchain_package_path</span><span class=s2>&#34;</span>:/open_explorer <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      -v <span class=s2>&#34;</span><span class=nv>$dataset_path</span><span class=s2>&#34;</span>:/data <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        openexplorer/ai_toolchain_centos_7_xj3:<span class=s2>&#34;</span><span class=si>${</span><span class=nv>version</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>å…¶ä¸­å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š</p><p><code>version</code> ä»£è¡¨ Docker é•œåƒç‰ˆæœ¬ï¼Œå¯é€‰ç‰ˆæœ¬å‚è€ƒï¼š<a href=https://developer.horizon.ai/forumDetail/136488103547258769>èµ„æ–™ä¸‹è½½ä¸“åŒº</a></p><p><code>ai_toolchain_package_path</code> ä»£è¡¨ OE å¼€å‘åŒ…çš„è·¯å¾„ï¼ŒæŒ‡å®š OE åŒ…ä¸­ ai_toolchain çš„è·¯å¾„ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æˆ‘å»ºè®®æŠŠæ•´ä¸ª OE åŒ…éƒ½æŒ‚è¿›å»å¾—äº†ï¼Œæ²¡å•¥å·®åˆ«ã€‚</p><p><code>dataset_path</code> ä»£è¡¨è®­ç»ƒéœ€è¦çš„æ•°æ®é›†è·¯å¾„ï¼Œè¿™é‡Œå¯ä»¥æ–°å»ºä¸€ä¸ªç©ºçš„æ–‡ä»¶å¤¹ç„¶åæŒ‚è½½è¿›å»ï¼Œä¹Ÿå¯ä»¥æŠŠä½ æ‰€æœ‰çš„æ•°æ®é›†éƒ½å‡†å¤‡å¥½ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åæŒ‚è¿›å»ï¼Œéœ€è¦è®­ç»ƒå“ªä¸ªåé¢æŒ‡å®šå“ªä¸ªå³å¯ï¼Œæˆ‘ä»¬è¿™é‡Œæ–¹ä¾¿èµ·è§å¯ä»¥é€‰æ‹©å‰è€…ï¼ˆå®˜æ–¹è¯´å¦‚æœè¿™é‡ŒæŒ‡å®šä¸ºç©ºå¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œä½†æ˜¯æˆ‘æµ‹è¯•å‘ç°æŒ‚è½½ç©ºæ–‡ä»¶å¤¹ä¸ä¼šæœ‰é—®é¢˜ï¼‰ã€‚</p><p><code>docker run</code> éƒ¨åˆ†å°±æ˜¯å¯åŠ¨ä¸€ä¸ª Docker å®¹å™¨ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„å‚æ•°ï¼š <code>-dt</code> å¯ä»¥è®©å®¹å™¨ä½¿ç”¨ Daemon çš„æ–¹å¼å¯åŠ¨ä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯ï¼Œå¯ä»¥ä¿è¯å®¹å™¨ä¸€ç›´å­˜æ´»ä¸ä¼š detach åå°±è¢«æ€æ­»ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¤šæ¬¡æ“ä½œï¼›<code>--restart=always</code> å¯ä»¥åœ¨æ¯æ¬¡å¼€æœºæ—¶è‡ªåŠ¨é‡å¯å®¹å™¨ï¼Œå¯ä»¥è§†è‡ªå·±çš„æƒ…å†µå»æ‰æˆ–è€…æ”¹æˆ <code>--restart=unless-stopped</code> ç­‰ï¼›<code>--network=host</code> æŒ‡å®šä¸å®¿ä¸»æœºå™¨ä½¿ç”¨åŒä¸€ä¸ªç½‘ç»œï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹æ–‡æ¡£æˆ–è€…åé¢çš„ç½‘ç»œç»“æ„ã€‚</p><hr><p>è®¾ç½®åå³å¯æ‰“å¼€ç»ˆç«¯ï¼Œä½¿ç”¨ <code>bash run_docker.sh</code> å¯åŠ¨å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ <code>docker exec -it {container_id} bash</code> æ¥è¿æ¥å®¹å™¨è¿›è¡Œæ“ä½œï¼Œå…¶ä¸­ <code>container_id</code> å¯ä»¥é€šè¿‡ <code>docker ps</code> æˆ–è€…ä¸Šè¿°è„šæœ¬çš„è¿”å›å€¼æŸ¥çœ‹ã€‚</p><p><img loading=lazy src=/images/hat-train-fcos/run_docker.png alt=image-20230224164845945></p><p>è¿›å…¥åå¯ä½¿ç”¨ <code>nvidia-smi</code> éªŒè¯ä¸€ä¸‹ï¼Œå‡ºç°ä¸‹æ–¹çš„ä¿¡æ¯å³ä»£è¡¨æˆåŠŸï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/nvidia_smi.png alt=image-20230224165703545></p><p>ç¯å¢ƒé…ç½®åˆ°æ­¤ç»“æŸï¼Œç»ˆäºå¯ä»¥å¼€å§‹è®­ç»ƒå’Œéƒ¨ç½²ç½‘ç»œäº†ã€‚</p><h2 id=è®­ç»ƒ-coco-æ•°æ®é›†å¹¶è¿›è¡Œéƒ¨ç½²>è®­ç»ƒ COCO æ•°æ®é›†å¹¶è¿›è¡Œéƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#è®­ç»ƒ-coco-æ•°æ®é›†å¹¶è¿›è¡Œéƒ¨ç½²>#</a></h2><h3 id=æ•°æ®å‡†å¤‡>æ•°æ®å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#æ•°æ®å‡†å¤‡>#</a></h3><blockquote><p>ä¸‹æ–¹çš„æ“ä½œå‡åœ¨ä¸Šæ–¹å¯åŠ¨çš„å®¹å™¨ä¸­è¿›è¡Œï¼Œé¦–å…ˆéœ€è¦å…ˆ docker exec è¿›å…¥å®¹å™¨ä¸­ã€‚</p></blockquote><p>å…¶ä¸­å‡†å¤‡ COCO æ•°æ®é›†éƒ¨åˆ†å‚è€ƒ <a href=https://developer.horizon.ai/api/v1/fileData/doc/ddk_doc/navigation/ai_toolchain/docs_cn/horizon_algorithm_toolkit/examples/fcos.html>å®˜æ–¹æ–‡æ¡£éƒ¨åˆ†</a>ï¼Œé¦–å…ˆè¿›å…¥ <code>/data</code> ç›®å½•ï¼Œç„¶åæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ <code>mscoco</code>ï¼Œä¸‹è½½æ•°æ®é›†ã€è§£å‹å³å¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è¿›å…¥ä¹‹å‰æŒ‚è½½çš„ /data ç›®å½•</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /data
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜å‚¨æ•°æ®é›†</span>
</span></span><span class=line><span class=cl>mkdir mscoco
</span></span><span class=line><span class=cl><span class=c1># ä¸‹è½½ train2017.zipï¼Œå³è®­ç»ƒæ•°æ®é›†</span>
</span></span><span class=line><span class=cl>wget -c http://images.cocodataset.org/zips/train2017.zip
</span></span><span class=line><span class=cl><span class=c1># ä¸‹è½½ val2017.zipï¼Œå³éªŒè¯æ•°æ®é›†</span>
</span></span><span class=line><span class=cl>wget -c http://images.cocodataset.org/zips/val2017.zip
</span></span><span class=line><span class=cl><span class=c1># ä¸‹è½½ annotations_trainval2017.zip å³å¯¹åº”æ ‡ç­¾</span>
</span></span><span class=line><span class=cl>wget -c http://images.cocodataset.org/annotations/annotations_trainval2017.zip
</span></span><span class=line><span class=cl><span class=c1># è§£å‹</span>
</span></span><span class=line><span class=cl>unzip train2017.zip 
</span></span><span class=line><span class=cl>unzip val2017.zip
</span></span><span class=line><span class=cl>unzip annotations_trainval2017.zip
</span></span></code></pre></div><p>éšåè¿›å…¥ <code>/open_explorer/horizon_model_train_samples</code> ç›®å½•ï¼Œå¦‚æœè¿™é‡Œä½ å’Œæˆ‘ä¹‹å‰ä¸€æ ·æ˜¯æŒ‚è½½çš„æ•´ä¸ª OE åŒ…ï¼Œé‚£è¿™ä¸ªè·¯å¾„å¯èƒ½ä¼šé•¿ä¸€äº›ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œæ˜¯ <code>/open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples</code>ã€‚</p><p>å°†æ•°æ®é›†æ‰“åŒ…æˆ lmdb æ ¼å¼ï¼Œæ³¨æ„ä¸‹æ–¹çš„ <code>/data/mscoco</code> è·¯å¾„æ˜¯æˆ‘ä»¬ä¹‹å‰å­˜æ”¾æ•°æ®é›†çš„è·¯å¾„ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è½¬æ¢è®­ç»ƒé›†</span>
</span></span><span class=line><span class=cl>python3 tools/datasets/mscoco_packer.py --src-data-dir /data/mscoco/ --target-data-dir /data/mscoco --split-name train --pack-type lmdb
</span></span><span class=line><span class=cl><span class=c1># è½¬æ¢éªŒè¯é›†</span>
</span></span><span class=line><span class=cl>python3 tools/datasets/mscoco_packer.py --src-data-dir /data/mscoco/ --target-data-dir /data/mscoco --split-name val --pack-type lmdb
</span></span></code></pre></div><p>è¿è¡Œå®Œå³æ‰“åŒ…æˆåŠŸï¼Œ<code>/data/mscoco</code> ç›®å½•ä¸‹ä¼šå¤šå‡ºæ¥ <code>train_lmdb</code> å’Œ <code>val_lmdb</code> ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œå³æ‰“åŒ…ä¹‹åçš„è®­ç»ƒæ•°æ®é›†å’ŒéªŒè¯æ•°æ®é›†ï¼Œä¹Ÿæ˜¯ç½‘ç»œæœ€ç»ˆè¯»å–çš„æ•°æ®é›†ã€‚</p><h3 id=ä¿®æ”¹é…ç½®æ–‡ä»¶>ä¿®æ”¹é…ç½®æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#ä¿®æ”¹é…ç½®æ–‡ä»¶>#</a></h3><p>åœ°å¹³çº¿æä¾›çš„ HAT å·¥å…·é“¾æ˜¯ä¸€ä¸ªç±» mmdetion çš„ä¸œè¥¿ï¼Œæ¨¡å‹å®šä¹‰ã€è®­ç»ƒã€éªŒè¯éƒ½æµç¨‹éƒ½å®šä¹‰åœ¨ä¸€ä¸ª config.py æ–‡ä»¶ä¸­ï¼Œå®˜æ–¹æä¾›çš„æ‰€æœ‰é…ç½®æ–‡ä»¶å¯ä»¥åœ¨ <code>configs</code> ç›®å½•ä¸‹æ‰¾åˆ°ï¼ŒFCOS å¯¹åº”çš„å°±æ˜¯ <code>configs/detection/fcos</code> ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬è¿™é‡Œåªè€ƒè™‘ <code>fcos_efficientnetb0_mscoco.py</code> ï¼Œå…³äºé…ç½®çš„è¿›ä¸€æ­¥è®²è§£ï¼Œå¯è§å®˜æ–¹æ–‡æ¡£ï¼š<a href=https://developer.horizon.ai/api/v1/fileData/doc/ddk_doc/navigation/ai_toolchain/docs_cn/horizon_algorithm_toolkit/tutorials/config.html>config æ–‡ä»¶ä»‹ç»</a>ã€‚</p><p>åœ¨ä¿®æ”¹ä¹‹å‰ï¼Œæœ€å¥½å…ˆå¤‡ä»½ä¸€ä¸‹åŸä»¶ï¼Œå¯ä»¥ä½œä¸ºå¯¹æ¯”ï¼Œä¹Ÿæ–¹ä¾¿å›æº¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp fcos_efficientnetb0_mscoco.py fcos_efficientnetb0_mscoco_back.py
</span></span></code></pre></div><p>è¦æ”¹çš„ç‚¹æœ‰ä¸‰ä¸ªï¼š</p><ol><li><code>device_ids</code>ï¼šè¿™é‡Œä»£è¡¨çš„æ˜¯ä½ ä½¿ç”¨çš„ GPU åºå·ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ª GPU å°±åªä¿ç•™ [0]ï¼Œä¸¤ä¸ªå°±æ˜¯ [0, 1]ï¼Œä»¥æ­¤ç±»æ¨ã€‚</li><li>æ‰€æœ‰è·Ÿ <code>./tmp_data</code> æœ‰å…³çš„ä½ç½®ï¼Œè¿™é‡Œç›¸å…³çš„éƒ½æ˜¯æŒ‡å®šçš„æ•°æ®é›†ä½ç½®ï¼Œå®˜æ–¹ä¸¾ä¾‹æ˜¯å°†æ•°æ®é›†éƒ½æ”¾åœ¨äº†åŒ configs åŒç›®å½•çš„ <code>tmp_data</code> ç›®å½•ï¼Œä½†æ˜¯æˆ‘ä»¬æ”¾åœ¨äº† <code>/data</code> ç›®å½•ï¼Œå› æ­¤è¦å°†æ‰€æœ‰çš„ <code>./tmp_data</code> éƒ½æ”¹æˆ <code>/data</code></li><li><code>float_trainer</code>ï¼šè¿™ä¸ªå‚æ•°æ˜¯ä¸ª Dictï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ª <code>num_epochs </code>ï¼Œä»£è¡¨æˆ‘ä»¬è®­ç»ƒå¤šå°‘è½®ï¼Œè¿™é‡Œé»˜è®¤æ˜¯ 300ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚è°ƒæ•´ï¼Œä¾‹å¦‚ 5ã€10ã€100 ç­‰ã€‚</li></ol><h3 id=å¼€å§‹è®­ç»ƒ>å¼€å§‹è®­ç»ƒï¼<a hidden class=anchor aria-hidden=true href=#å¼€å§‹è®­ç»ƒ>#</a></h3><p>è®­ç»ƒå¾ˆç®€å•ï¼Œä¸€è¡Œå‘½ä»¤å³å¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è¿›å…¥ horizon_model_train_samples ç›®å½•</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples
</span></span><span class=line><span class=cl><span class=c1># å¼€å§‹è®­ç»ƒ</span>
</span></span><span class=line><span class=cl>python3 tools/train.py --step float --config configs/detection/fcos/fcos_efficientnetb0_mscoco.py
</span></span></code></pre></div><p>å¦‚æœä¸å‡ºæ„å¤–ï¼Œå·²ç»å¼€å§‹è®­ç»ƒäº†ï¼Œæ­£å¸¸å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/fcos_train.png alt=image-20230224180032520></p><p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™é‡Œæ¨èé…åˆ <a href=https://github.com/tmux/tmux>tmux</a> å·¥å…·æ¥è®­ç»ƒï¼Œå¯ä»¥è®© session åœ¨åå°è¿è¡Œï¼Œé˜²æ­¢æ„å¤–ä¸­æ–­ï¼Œé¡ºé™„ä¸€ä¸ª tmux æ•™ç¨‹ï¼š<a href=https://www.ruanyifeng.com/blog/2019/10/tmux.html>Tmux ä½¿ç”¨æ•™ç¨‹</a>ã€‚</p><h3 id=æ¨¡å‹è½¬æ¢>æ¨¡å‹è½¬æ¢<a hidden class=anchor aria-hidden=true href=#æ¨¡å‹è½¬æ¢>#</a></h3><p>è®­ç»ƒçš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œä¸»è¦å–å†³äºæ•°æ®é›†çš„å¤§å°ï¼Œå¦‚æœæ˜¯ mscoco è¿™ç§å¤§å‹æ•°æ®é›†ï¼Œä¸€ä¸ª epoch å°±è¦å¥½ä¹…æ‰è¡Œã€‚</p><p>è¿™é‡Œæˆ‘è®­ç»ƒäº†åè½®å°±ç»“æŸäº†ï¼Œéšåè¿›å…¥ <code>tmp_models</code> ç›®å½•ï¼Œæ‰¾åˆ°æˆ‘ä»¬è®­ç»ƒå¥½çš„æƒé‡æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼Œè¿™é‡Œçš„å­˜æ”¾ä½ç½®ä¸»è¦å’Œé…ç½®æ–‡ä»¶ä¸­çš„ <code>task_name</code> ä¸ <code>ckpt_dir</code> æœ‰å…³ï¼Œå¯ä»¥æŒ‰éœ€ä¿®æ”¹ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/checkpoint.png alt=image-20230224180356435></p><p>æ¥ä¸‹æ¥å°±æ˜¯å°†æƒé‡æ–‡ä»¶å¯¼å‡ºæˆ ONNX æ¨¡å‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 tools/export_onnx.py --config configs/detection/fcos/fcos_efficientnetb0_mscoco.py --ckpt tmp_models/fcos_efficientnetb0_mscoco/float-checkpoint-best.pth.tar --onnx-name fcos.onnx
</span></span></code></pre></div><p>å¦‚ä¸Šå‘½ä»¤ï¼Œå°†è®­ç»ƒå¾—åˆ°çš„ best æƒé‡æ–‡ä»¶ï¼ˆfloat-checkpoint-best.pth.tarï¼‰å¯¼å‡ºæˆäº† fcos.onnx æ¨¡å‹æ–‡ä»¶ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„æƒé‡ï¼ŒæŒ‡å®šå¯¹æ¨¡å‹è·¯å¾„å³å¯ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ä½¿ç”¨åœ°å¹³çº¿çš„å·¥å…·é“¾å¯¹ ONNX æ¨¡å‹è¿›è¡Œé‡åŒ–ï¼Œä»¥ä¾¿æˆ‘ä»¬åé¢ä¸Šæ¿æ¨ç†ï¼š</p><p>ç¬¬ä¸€æ­¥ï¼Œå…ˆç§»åŠ¨ä¸€ä¸‹å¾—åˆ°çš„æƒé‡æ–‡ä»¶ï¼Œæ–¹ä¾¿åé¢çš„æŸ¥æ‰¾ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è¿›å…¥ horizon_model_train_samples ç›®å½•</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples
</span></span><span class=line><span class=cl><span class=c1># å»ºç«‹æ–‡ä»¶å¤¹</span>
</span></span><span class=line><span class=cl>mkdir -p ../horizon_model_convert_sample/08_customs
</span></span><span class=line><span class=cl><span class=c1># ç§»åŠ¨ onnx æ¨¡å‹è¿‡å»</span>
</span></span><span class=line><span class=cl>cp ./fcos.onnx ../horizon_model_convert_sample/08_customs
</span></span></code></pre></div><p>æ¥ä¸‹æ¥å°±æ˜¯é‚£å¥—æ ‡å‡†çš„è½¬æ¢æµç¨‹ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ•™ç¨‹ï¼š<a href=https://developer.horizon.ai/api/v1/fileData/documents_pi/ai_toolchain_develop/quickstart.html>6.3 å¿«é€Ÿä½“éªŒ</a>ï¼Œè¿˜æœ‰å¤§ä½¬çš„æŒ‡å—ï¼š<a href=https://developer.horizon.ai/forumDetail/107952931390742029>ä¸€æ–‡å¸¦ä½ è½»æ¾èµ°å‡ºæ¨¡å‹éƒ¨ç½²æ–°æ‰‹æ‘</a>ã€‚</p><p>ä¸»è¦æ˜¯æ¶‰åŠæ¨¡å‹åœ°å€å’Œæ•°æ®é›†åœ°å€çš„æ—¶å€™éœ€è¦æ”¹æˆæˆ‘ä»¬å¯¹åº”çš„å³å¯ï¼Œå…¶ä»–çš„éƒ½é»˜è®¤å°±è¡Œï¼Œæ¥ä¸‹æ¥ç»™å‡ºæˆ‘çš„å‡ ä¸ªè„šæœ¬åŠç²¾ç®€åçš„è½¬æ¢é…ç½®æ–‡ä»¶ï¼š</p><ul><li>01_check.sh</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 01_check.sh</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e -v
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=k>$(</span>dirname <span class=nv>$0</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>model_type</span><span class=o>=</span><span class=s2>&#34;onnx&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>onnx_model</span><span class=o>=</span><span class=s2>&#34;../../../08_customs/fcos.onnx&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>march</span><span class=o>=</span><span class=s2>&#34;bernoulli2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hb_mapper checker --model-type <span class=si>${</span><span class=nv>model_type</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  --model <span class=si>${</span><span class=nv>onnx_model</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  --march <span class=si>${</span><span class=nv>march</span><span class=si>}</span>
</span></span></code></pre></div><ul><li>02_preprocess.sh</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 02_preprocess.sh</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e -v
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=k>$(</span>dirname <span class=nv>$0</span><span class=k>)</span> <span class=o>||</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python3 ../../../data_preprocess.py <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --src_dir /data/mscoco/train2017 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --dst_dir ./calibration_data_yuv_f32 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cal_img_num <span class=m>50</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --pic_ext .yuv <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --read_mode opencv <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --saved_data_type float32
</span></span></code></pre></div><ul><li>fcos_efficientnetb0_config.yaml</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># fcos_efficientnetb0_config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>model_parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>onnx_model</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;../../../08_customs/fcos.onnx&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>march</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;bernoulli2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>layer_out_dump</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>working_dir</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;fcos_test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output_model_file_prefix</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;fcos_test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>input_parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>input_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>input_type_rt</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;nv12&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>input_type_train</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;yuv444&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>input_layout_train</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;NCHW&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>input_shape</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>norm_type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;data_mean_and_scale&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mean_value</span><span class=p>:</span><span class=w> </span><span class=m>128.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scale_value</span><span class=p>:</span><span class=w> </span><span class=m>0.0078125</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>calibration_parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cal_data_dir</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;./calibration_data_yuv_f32_qyun&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cal_data_type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;float32&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>calibration_type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;max&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>max_percentile</span><span class=p>:</span><span class=w> </span><span class=m>0.99996</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>compiler_parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compile_mode</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;latency&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>optimize_level</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;O3&#39;</span><span class=w>
</span></span></span></code></pre></div><p>è¿™é‡Œç†è®ºä¸Šåªéœ€è¦æ‰§è¡Œå®Œ <code>03_build.sh</code> è„šæœ¬è½¬æ¢å³ç»“æŸï¼Œä¸å‡ºæ„å¤–åœ¨åŒç›®å½•ä¸‹ä¼šç”Ÿæˆ <code>fcos_test</code> ç›®å½•ï¼Œå·²ç»åœ¨å…¶ä¸­å¯æ‰¾åˆ° <code>fcos.bin</code> ï¼Œè¿™å³æ˜¯æˆ‘ä»¬åç»­ä¸Šæ¿æ¨ç†éœ€è¦çš„æ¨¡å‹æ–‡ä»¶ã€‚</p><h3 id=æ¨¡å‹æ¨ç†>æ¨¡å‹æ¨ç†<a hidden class=anchor aria-hidden=true href=#æ¨¡å‹æ¨ç†>#</a></h3><p>è¿™é‡Œ Python æ¨ç†æˆ‘å‚è€ƒäº† X3M æ¿å­ä¸Š <code>/app/ai_inference/02_usb_camera_sample/usb_camera_fcos.py</code> ç›®å½•ä¸‹çš„æ¨ç†è„šæœ¬ï¼Œç›´æ¥ä¸Šä»£ç ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hobot_dnn</span> <span class=kn>import</span> <span class=n>pyeasy_dnn</span> <span class=k>as</span> <span class=n>dnn</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hobot_vio</span> <span class=kn>import</span> <span class=n>libsrcampy</span> <span class=k>as</span> <span class=n>srcampy</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>colorsys</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># detection model class names</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_classes</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=s2>&#34;person&#34;</span><span class=p>,</span> <span class=s2>&#34;bicycle&#34;</span><span class=p>,</span> <span class=s2>&#34;car&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;motorcycle&#34;</span><span class=p>,</span> <span class=s2>&#34;airplane&#34;</span><span class=p>,</span> <span class=s2>&#34;bus&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;train&#34;</span><span class=p>,</span> <span class=s2>&#34;truck&#34;</span><span class=p>,</span> <span class=s2>&#34;boat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;traffic light&#34;</span><span class=p>,</span> <span class=s2>&#34;fire hydrant&#34;</span><span class=p>,</span> <span class=s2>&#34;stop sign&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;parking meter&#34;</span><span class=p>,</span> <span class=s2>&#34;bench&#34;</span><span class=p>,</span> <span class=s2>&#34;bird&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;cat&#34;</span><span class=p>,</span> <span class=s2>&#34;dog&#34;</span><span class=p>,</span> <span class=s2>&#34;horse&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;sheep&#34;</span><span class=p>,</span> <span class=s2>&#34;cow&#34;</span><span class=p>,</span> <span class=s2>&#34;elephant&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;bear&#34;</span><span class=p>,</span> <span class=s2>&#34;zebra&#34;</span><span class=p>,</span> <span class=s2>&#34;giraffe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;backpack&#34;</span><span class=p>,</span> <span class=s2>&#34;umbrella&#34;</span><span class=p>,</span> <span class=s2>&#34;handbag&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;tie&#34;</span><span class=p>,</span> <span class=s2>&#34;suitcase&#34;</span><span class=p>,</span> <span class=s2>&#34;frisbee&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;skis&#34;</span><span class=p>,</span> <span class=s2>&#34;snowboard&#34;</span><span class=p>,</span> <span class=s2>&#34;sports ball&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;kite&#34;</span><span class=p>,</span> <span class=s2>&#34;baseball bat&#34;</span><span class=p>,</span> <span class=s2>&#34;baseball glove&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;skateboard&#34;</span><span class=p>,</span> <span class=s2>&#34;surfboard&#34;</span><span class=p>,</span> <span class=s2>&#34;tennis racket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;bottle&#34;</span><span class=p>,</span> <span class=s2>&#34;wine glass&#34;</span><span class=p>,</span> <span class=s2>&#34;cup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;fork&#34;</span><span class=p>,</span> <span class=s2>&#34;knife&#34;</span><span class=p>,</span> <span class=s2>&#34;spoon&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;bowl&#34;</span><span class=p>,</span> <span class=s2>&#34;banana&#34;</span><span class=p>,</span> <span class=s2>&#34;apple&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;sandwich&#34;</span><span class=p>,</span> <span class=s2>&#34;orange&#34;</span><span class=p>,</span> <span class=s2>&#34;broccoli&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;carrot&#34;</span><span class=p>,</span> <span class=s2>&#34;hot dog&#34;</span><span class=p>,</span> <span class=s2>&#34;pizza&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;donut&#34;</span><span class=p>,</span> <span class=s2>&#34;cake&#34;</span><span class=p>,</span> <span class=s2>&#34;chair&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;couch&#34;</span><span class=p>,</span> <span class=s2>&#34;potted plant&#34;</span><span class=p>,</span> <span class=s2>&#34;bed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;dining table&#34;</span><span class=p>,</span> <span class=s2>&#34;toilet&#34;</span><span class=p>,</span> <span class=s2>&#34;tv&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;laptop&#34;</span><span class=p>,</span> <span class=s2>&#34;mouse&#34;</span><span class=p>,</span> <span class=s2>&#34;remote&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;keyboard&#34;</span><span class=p>,</span> <span class=s2>&#34;cell phone&#34;</span><span class=p>,</span> <span class=s2>&#34;microwave&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;oven&#34;</span><span class=p>,</span> <span class=s2>&#34;toaster&#34;</span><span class=p>,</span> <span class=s2>&#34;sink&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;refrigerator&#34;</span><span class=p>,</span> <span class=s2>&#34;book&#34;</span><span class=p>,</span> <span class=s2>&#34;clock&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;vase&#34;</span><span class=p>,</span> <span class=s2>&#34;scissors&#34;</span><span class=p>,</span> <span class=s2>&#34;teddy bear&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=s2>&#34;hair drier&#34;</span><span class=p>,</span> <span class=s2>&#34;toothbrush&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># return np.array([&#34;tissue&#34;, &#34;sock&#34;, &#34;shoe&#34;, &#34;cable&#34;, &#34;bin&#34;])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># bgræ ¼å¼å›¾ç‰‡è½¬æ¢æˆ NV12æ ¼å¼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bgr2nv12_opencv</span><span class=p>(</span><span class=n>image</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>height</span><span class=p>,</span> <span class=n>width</span> <span class=o>=</span> <span class=n>image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>area</span> <span class=o>=</span> <span class=n>height</span> <span class=o>*</span> <span class=n>width</span>
</span></span><span class=line><span class=cl>    <span class=n>yuv420p</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2YUV_I420</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=n>area</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>//</span> <span class=mi>2</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=n>yuv420p</span><span class=p>[:</span><span class=n>area</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>uv_planar</span> <span class=o>=</span> <span class=n>yuv420p</span><span class=p>[</span><span class=n>area</span><span class=p>:]</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span> <span class=n>area</span> <span class=o>//</span> <span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>uv_packed</span> <span class=o>=</span> <span class=n>uv_planar</span><span class=o>.</span><span class=n>transpose</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=n>area</span> <span class=o>//</span> <span class=mi>2</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>nv12</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>yuv420p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>nv12</span><span class=p>[:</span><span class=n>height</span> <span class=o>*</span> <span class=n>width</span><span class=p>]</span> <span class=o>=</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>    <span class=n>nv12</span><span class=p>[</span><span class=n>height</span> <span class=o>*</span> <span class=n>width</span><span class=p>:]</span> <span class=o>=</span> <span class=n>uv_packed</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nv12</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>postprocess</span><span class=p>(</span><span class=n>model_output</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>model_hw_shape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>origin_image</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>origin_img_shape</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>score_threshold</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>nms_threshold</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>dump_image</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>input_height</span> <span class=o>=</span> <span class=n>model_hw_shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>input_width</span> <span class=o>=</span> <span class=n>model_hw_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>origin_image</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>origin_image_shape</span> <span class=o>=</span> <span class=n>origin_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>origin_image_shape</span> <span class=o>=</span> <span class=n>origin_img_shape</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>prediction_bbox</span> <span class=o>=</span> <span class=n>decode</span><span class=p>(</span><span class=n>outputs</span><span class=o>=</span><span class=n>model_output</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>score_threshold</span><span class=o>=</span><span class=n>score_threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>origin_shape</span><span class=o>=</span><span class=n>origin_image_shape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>input_size</span><span class=o>=</span><span class=mi>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>prediction_bbox</span> <span class=o>=</span> <span class=n>nms</span><span class=p>(</span><span class=n>prediction_bbox</span><span class=p>,</span> <span class=n>iou_threshold</span><span class=o>=</span><span class=n>nms_threshold</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>prediction_bbox</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>prediction_bbox</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>topk</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>prediction_bbox</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>topk</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argpartition</span><span class=p>(</span><span class=n>prediction_bbox</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>4</span><span class=p>],</span> <span class=o>-</span><span class=n>topk</span><span class=p>)[</span><span class=o>-</span><span class=n>topk</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>prediction_bbox</span> <span class=o>=</span> <span class=n>prediction_bbox</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>dump_image</span> <span class=ow>and</span> <span class=n>origin_image</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>draw_bboxs</span><span class=p>(</span><span class=n>origin_image</span><span class=p>,</span> <span class=n>prediction_bbox</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>prediction_bbox</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>draw_bboxs</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>bboxes</span><span class=p>,</span> <span class=n>gt_classes_index</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>classes</span><span class=o>=</span><span class=n>get_classes</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;draw the bboxes in the original image
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>num_classes</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>classes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>image_h</span><span class=p>,</span> <span class=n>image_w</span><span class=p>,</span> <span class=n>channel</span> <span class=o>=</span> <span class=n>image</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=n>hsv_tuples</span> <span class=o>=</span> <span class=p>[(</span><span class=mf>1.0</span> <span class=o>*</span> <span class=n>x</span> <span class=o>/</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mf>1.</span><span class=p>,</span> <span class=mf>1.</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_classes</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>colors</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>colorsys</span><span class=o>.</span><span class=n>hsv_to_rgb</span><span class=p>(</span><span class=o>*</span><span class=n>x</span><span class=p>),</span> <span class=n>hsv_tuples</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>colors</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>255</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=mi>255</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>*</span> <span class=mi>255</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=n>colors</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fontScale</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    <span class=n>bbox_thick</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=mf>0.6</span> <span class=o>*</span> <span class=p>(</span><span class=n>image_h</span> <span class=o>+</span> <span class=n>image_w</span><span class=p>)</span> <span class=o>/</span> <span class=mi>600</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>bbox</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>bboxes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>coor</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>bbox</span><span class=p>[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>gt_classes_index</span> <span class=o>==</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>class_index</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>bbox</span><span class=p>[</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>=</span> <span class=n>bbox</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>class_index</span> <span class=o>=</span> <span class=n>gt_classes_index</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>bbox_color</span> <span class=o>=</span> <span class=n>colors</span><span class=p>[</span><span class=n>class_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>c1</span><span class=p>,</span> <span class=n>c2</span> <span class=o>=</span> <span class=p>(</span><span class=n>coor</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>coor</span><span class=p>[</span><span class=mi>1</span><span class=p>]),</span> <span class=p>(</span><span class=n>coor</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>coor</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>c1</span><span class=p>,</span> <span class=n>c2</span><span class=p>,</span> <span class=n>bbox_color</span><span class=p>,</span> <span class=n>bbox_thick</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>classes_name</span> <span class=o>=</span> <span class=n>classes</span><span class=p>[</span><span class=n>class_index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox_mess</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>: </span><span class=si>%.2f</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>classes_name</span><span class=p>,</span> <span class=n>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>t_size</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>getTextSize</span><span class=p>(</span><span class=n>bbox_mess</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>fontScale</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>thickness</span><span class=o>=</span><span class=n>bbox_thick</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>cv2</span><span class=o>.</span><span class=n>rectangle</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>c1</span><span class=p>,</span> <span class=p>(</span><span class=n>c1</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>t_size</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>c1</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>t_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                      <span class=n>bbox_color</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cv2</span><span class=o>.</span><span class=n>putText</span><span class=p>(</span><span class=n>image</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>bbox_mess</span><span class=p>,</span> <span class=p>(</span><span class=n>c1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>c1</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>cv2</span><span class=o>.</span><span class=n>FONT_HERSHEY_SIMPLEX</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>fontScale</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>bbox_thick</span> <span class=o>//</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>lineType</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>LINE_AA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{}</span><span class=s2> is in the picture with confidence:</span><span class=si>{:.4f}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>classes_name</span><span class=p>,</span> <span class=n>score</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    cv2.imwrite(&#34;demo.jpg&#34;, image)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode</span><span class=p>(</span><span class=n>outputs</span><span class=p>,</span> <span class=n>score_threshold</span><span class=p>,</span> <span class=n>origin_shape</span><span class=p>,</span> <span class=n>input_size</span><span class=o>=</span><span class=mi>512</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_distance2bbox</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>distance</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>x1</span> <span class=o>=</span> <span class=n>points</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>distance</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>y1</span> <span class=o>=</span> <span class=n>points</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>distance</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>x2</span> <span class=o>=</span> <span class=n>points</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>distance</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>y2</span> <span class=o>=</span> <span class=n>points</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>distance</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>],</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_scores</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>ce</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>cls</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=bp>cls</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>ce</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>ce</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ce</span> <span class=o>*</span> <span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_bbox</span><span class=p>(</span><span class=n>bbox</span><span class=p>,</span> <span class=n>stride</span><span class=p>,</span> <span class=n>origin_shape</span><span class=p>,</span> <span class=n>input_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># l t r b | h, w = t, r</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>bbox</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>yv</span><span class=p>,</span> <span class=n>xv</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>meshgrid</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>h</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=n>w</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>xy</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>((</span><span class=n>yv</span><span class=p>,</span> <span class=n>xv</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>)</span> <span class=o>*</span> <span class=n>stride</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox</span> <span class=o>=</span> <span class=n>_distance2bbox</span><span class=p>(</span><span class=n>xy</span><span class=p>,</span> <span class=n>bbox</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># opencv read, shape[1] is w, shape[0] is h</span>
</span></span><span class=line><span class=cl>        <span class=n>scale_w</span> <span class=o>=</span> <span class=n>origin_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>/</span> <span class=n>input_size</span>
</span></span><span class=line><span class=cl>        <span class=n>scale_h</span> <span class=o>=</span> <span class=n>origin_shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>/</span> <span class=n>input_size</span>
</span></span><span class=line><span class=cl>        <span class=n>scale</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>origin_shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>origin_shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>input_size</span>
</span></span><span class=line><span class=cl>        <span class=c1># origin img is pad resized</span>
</span></span><span class=line><span class=cl>        <span class=c1># bbox = bbox * scale</span>
</span></span><span class=line><span class=cl>        <span class=c1># origin img is resized</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox</span> <span class=o>=</span> <span class=n>bbox</span> <span class=o>*</span> <span class=p>[</span><span class=n>scale_w</span><span class=p>,</span> <span class=n>scale_h</span><span class=p>,</span> <span class=n>scale_w</span><span class=p>,</span> <span class=n>scale_h</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bbox</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bboxes</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>strides</span> <span class=o>=</span> <span class=p>[</span><span class=mi>8</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>128</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å„ä¸ª stride æ‰¾ç¬¦åˆçš„æ¨¡å‹</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>strides</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=bp>cls</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>5</span><span class=p>]</span><span class=o>.</span><span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>ce</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>10</span><span class=p>]</span><span class=o>.</span><span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=n>_scores</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>ce</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>classes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>scores</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>classes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>classes</span><span class=p>,</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>max_score</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>scores</span><span class=p>,</span> <span class=n>axis</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>max_score</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>max_score</span><span class=p>,</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox</span> <span class=o>=</span> <span class=n>_bbox</span><span class=p>(</span><span class=n>bbox</span><span class=p>,</span> <span class=n>strides</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>origin_shape</span><span class=p>,</span> <span class=n>input_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>bbox</span><span class=p>,</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pred_bbox</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>bbox</span><span class=p>,</span> <span class=n>max_score</span><span class=p>,</span> <span class=n>classes</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>index</span> <span class=o>=</span> <span class=n>pred_bbox</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>score_threshold</span>
</span></span><span class=line><span class=cl>        <span class=n>pred_bbox</span> <span class=o>=</span> <span class=n>pred_bbox</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>bboxes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>pred_bbox</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>bboxes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>nms</span><span class=p>(</span><span class=n>bboxes</span><span class=p>,</span> <span class=n>iou_threshold</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;nms&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bboxes_iou</span><span class=p>(</span><span class=n>boxes1</span><span class=p>,</span> <span class=n>boxes2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>boxes1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>boxes1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>boxes2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>boxes2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>boxes1_area</span> <span class=o>=</span> <span class=p>(</span><span class=n>boxes1</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>boxes1</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span> <span class=o>*</span> \
</span></span><span class=line><span class=cl>                      <span class=p>(</span><span class=n>boxes1</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span> <span class=o>-</span> <span class=n>boxes1</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>boxes2_area</span> <span class=o>=</span> <span class=p>(</span><span class=n>boxes2</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>boxes2</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span> <span class=o>*</span> \
</span></span><span class=line><span class=cl>                      <span class=p>(</span><span class=n>boxes2</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span> <span class=o>-</span> <span class=n>boxes2</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>left_up</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>boxes1</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=p>:</span><span class=mi>2</span><span class=p>],</span> <span class=n>boxes2</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=p>:</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>right_down</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>boxes1</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>2</span><span class=p>:],</span> <span class=n>boxes2</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>2</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=n>inter_section</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>right_down</span> <span class=o>-</span> <span class=n>left_up</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>inter_area</span> <span class=o>=</span> <span class=n>inter_section</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>inter_section</span><span class=p>[</span><span class=o>...</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>union_area</span> <span class=o>=</span> <span class=n>boxes1_area</span> <span class=o>+</span> <span class=n>boxes2_area</span> <span class=o>-</span> <span class=n>inter_area</span>
</span></span><span class=line><span class=cl>        <span class=n>ious</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=mf>1.0</span> <span class=o>*</span> <span class=n>inter_area</span> <span class=o>/</span> <span class=n>union_area</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=n>np</span><span class=o>.</span><span class=n>finfo</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span><span class=o>.</span><span class=n>eps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ious</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>classes_in_img</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>bboxes</span><span class=p>[:,</span> <span class=mi>5</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>best_bboxes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=bp>cls</span> <span class=ow>in</span> <span class=n>classes_in_img</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cls_mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>bboxes</span><span class=p>[:,</span> <span class=mi>5</span><span class=p>]</span> <span class=o>==</span> <span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cls_bboxes</span> <span class=o>=</span> <span class=n>bboxes</span><span class=p>[</span><span class=n>cls_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>cls_bboxes</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>max_ind</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>cls_bboxes</span><span class=p>[:,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>best_bbox</span> <span class=o>=</span> <span class=n>cls_bboxes</span><span class=p>[</span><span class=n>max_ind</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>best_bboxes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>best_bbox</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cls_bboxes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span><span class=n>cls_bboxes</span><span class=p>[:</span><span class=n>max_ind</span><span class=p>],</span> <span class=n>cls_bboxes</span><span class=p>[</span><span class=n>max_ind</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:]])</span>
</span></span><span class=line><span class=cl>            <span class=n>iou</span> <span class=o>=</span> <span class=n>bboxes_iou</span><span class=p>(</span><span class=n>best_bbox</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>newaxis</span><span class=p>,</span> <span class=p>:</span><span class=mi>4</span><span class=p>],</span> <span class=n>cls_bboxes</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>weight</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>((</span><span class=nb>len</span><span class=p>(</span><span class=n>iou</span><span class=p>),),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=n>method</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;nms&#39;</span><span class=p>,</span> <span class=s1>&#39;soft-nms&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;nms&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>iou_mask</span> <span class=o>=</span> <span class=n>iou</span> <span class=o>&gt;</span> <span class=n>iou_threshold</span>
</span></span><span class=line><span class=cl>                <span class=n>weight</span><span class=p>[</span><span class=n>iou_mask</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;soft-nms&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>weight</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=mf>1.0</span> <span class=o>*</span> <span class=n>iou</span> <span class=o>**</span> <span class=mi>2</span> <span class=o>/</span> <span class=n>sigma</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>cls_bboxes</span><span class=p>[:,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>cls_bboxes</span><span class=p>[:,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>*</span> <span class=n>weight</span>
</span></span><span class=line><span class=cl>            <span class=n>score_mask</span> <span class=o>=</span> <span class=n>cls_bboxes</span><span class=p>[:,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mf>0.</span>
</span></span><span class=line><span class=cl>            <span class=n>cls_bboxes</span> <span class=o>=</span> <span class=n>cls_bboxes</span><span class=p>[</span><span class=n>score_mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>best_bboxes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_properties</span><span class=p>(</span><span class=n>pro</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;tensor type:&#34;</span><span class=p>,</span> <span class=n>pro</span><span class=o>.</span><span class=n>tensor_type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;data type:&#34;</span><span class=p>,</span> <span class=n>pro</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;layout:&#34;</span><span class=p>,</span> <span class=n>pro</span><span class=o>.</span><span class=n>layout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape:&#34;</span><span class=p>,</span> <span class=n>pro</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>models</span> <span class=o>=</span> <span class=n>dnn</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>&#39;./models/fcos.bin&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ‰“å°è¾“å…¥ tensor çš„å±æ€§</span>
</span></span><span class=line><span class=cl>    <span class=n>print_properties</span><span class=p>(</span><span class=n>models</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>inputs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>properties</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ‰“å°è¾“å‡º tensor çš„å±æ€§</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>models</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>outputs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>output</span> <span class=ow>in</span> <span class=n>models</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>outputs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>print_properties</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>properties</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>frame</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=s2>&#34;./kite.jpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>frame</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Image is not exist.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>height</span><span class=p>,</span> <span class=n>width</span> <span class=o>=</span> <span class=n>frame</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;height: &#34;</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=s2>&#34;width: &#34;</span><span class=p>,</span> <span class=n>width</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># æŠŠå›¾ç‰‡ç¼©æ”¾åˆ°æ¨¡å‹çš„è¾“å…¥å°ºå¯¸</span>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–ç®—æ³•æ¨¡å‹çš„è¾“å…¥tensor çš„å°ºå¯¸</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>models</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>inputs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>properties</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>models</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>inputs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>properties</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>des_dim</span> <span class=o>=</span> <span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>resized_data</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>frame</span><span class=p>,</span> <span class=n>des_dim</span><span class=p>,</span> <span class=n>interpolation</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>INTER_AREA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>nv12_data</span> <span class=o>=</span> <span class=n>bgr2nv12_opencv</span><span class=p>(</span><span class=n>resized_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Forward</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>models</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>nv12_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Do post process</span>
</span></span><span class=line><span class=cl>    <span class=n>input_shape</span> <span class=o>=</span> <span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prediction_bbox</span> <span class=o>=</span> <span class=n>postprocess</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span><span class=p>,</span> <span class=n>input_shape</span><span class=p>,</span> <span class=n>origin_img_shape</span><span class=o>=</span><span class=p>(</span><span class=n>height</span><span class=p>,</span> <span class=n>width</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>frame</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=n>height</span> <span class=ow>or</span> <span class=n>frame</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=n>width</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>frame</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>frame</span><span class=p>,</span> <span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                           <span class=n>interpolation</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>INTER_AREA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Draw bboxs</span>
</span></span><span class=line><span class=cl>    <span class=n>box_bgr</span> <span class=o>=</span> <span class=n>draw_bboxs</span><span class=p>(</span><span class=n>frame</span><span class=p>,</span> <span class=n>prediction_bbox</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cv2</span><span class=o>.</span><span class=n>imwrite</span><span class=p>(</span><span class=s2>&#34;kite_with_bbox.jpg&#34;</span><span class=p>,</span> <span class=n>box_bgr</span><span class=p>)</span>
</span></span></code></pre></div><p>å…¶å®æµç¨‹è¿˜æ˜¯è›®ç®€å•çš„ï¼Œå°±æ˜¯ åŠ è½½æ¨¡å‹ -> è¯»å–ç…§ç‰‡ -> Resize ç…§ç‰‡åˆ°æ¨¡å‹æ¨ç†å°ºå¯¸ -> è½¬åŒ–ä¸º NV12 è¾“å…¥æ ¼å¼ -> æ‹¿åˆ°è¾“å‡º outputs -> å¯¹æ•°æ®é›†è¿›è¡Œåå¤„ç†å¾—åˆ° bbox ä¸ classes ç­‰æ•°æ® -> Resize ç…§ç‰‡åˆ°åŸå°ºå¯¸ç»˜åˆ¶æ¡† -> å†™ç…§ç‰‡ã€‚</p><p>å¤§å®¶æ‹¿è„šæœ¬æ¨ç†çš„æ—¶å€™ï¼Œåªéœ€è¦æ”¹å˜ models å’Œè¯»å–ç…§ç‰‡çš„ä½ç½®å³å¯ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨çš„ç¤ºä¾‹å›¾ç‰‡æ˜¯åœ¨æ¨¡å‹è½¬åŒ–åæµ‹è¯•æ¨ç†ä½¿ç”¨çš„ï¼Œå¯ä»¥åœ¨ OE åŒ…çš„å¦‚ä¸‹è·¯å¾„æ‰¾åˆ° <code>ai_toolchain/horizon_model_convert_sample/01_common/test_data/det_images/kite.jpg</code>ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯è¿è¡Œè„šæœ¬è¿›è¡Œæ¨ç†ï¼Œå¾—åˆ°çš„æ¨ç†ç»“æœå¦‚ä¸‹ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/bad_kite_bbox.png alt=image-20230224191320596></p><p>ä¸ºä»€ä¹ˆç»“æœæ˜¯è¿™æ ·çš„ï¼Œèµ·åˆæˆ‘è®¤ä¸ºæ˜¯æˆ‘æ¨ç†è„šæœ¬å†™é”™äº†ï¼Œå› æ­¤æˆ‘ç›´æ¥å°†æƒé‡æ›¿æ¢ä¸ºå®˜æ–¹çš„æƒé‡ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/kite_bbox.png alt=image-20230224191427658></p><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™æ¬¡çš„æ¨ç†æ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜ï¼Œè„šæœ¬æ˜¯æ²¡é—®é¢˜ï¼Œåªæ˜¯æƒé‡å‡ºäº†é—®é¢˜ï¼Œå› æ­¤æˆ‘åˆä»”ç»†æ£€æŸ¥äº†è®­ç»ƒå’Œæ¨¡å‹è½¬æ¢çš„å„ä¸ªæ­¥éª¤ï¼Œä½†éƒ½æ²¡æœ‰å‘ç°é—®é¢˜ã€‚åŒæ—¶ï¼Œä½¿ç”¨å®˜æ–¹æä¾›çš„ mapper ç›®å½•ä¸‹åŸ onnx è¿›è¡Œè½¬æ¢åï¼Œä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚é‚£ä¹ˆé—®é¢˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><h3 id=æŸ¥æ‰¾é—®é¢˜>æŸ¥æ‰¾é—®é¢˜<a hidden class=anchor aria-hidden=true href=#æŸ¥æ‰¾é—®é¢˜>#</a></h3><p>å› ä¸ºé€šè¿‡ä¸Šé¢çš„æ’é™¤å¯ä»¥ç¡®å®šï¼Œè½¬åŒ–è¿™ä¸ªè¿‡ç¨‹æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ï¼Œé‚£ä¹Ÿå°±åªèƒ½æ˜¯æ¨¡å‹å®šä¹‰å’Œè®­ç»ƒä¸­å‡ºç°çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸Šé¢çš„æ•ˆæœåˆæ˜æ˜¾ä¸æ˜¯è®­ç»ƒè¿‡æ‹Ÿåˆæˆ–è€…æ¬ æ‹Ÿåˆå¯¼è‡´çš„ï¼Œå› ä¸ºæ¡†çš„ä½ç½®æ˜¯å¤§è‡´å¯¹çš„ï¼Œå°±æ˜¯å¤ªå¤šäº†ï¼Œè€Œä¸”å¤ªå°äº†ï¼Œå› æ­¤æˆ‘æ€€ç–‘æ˜¯æ¨¡å‹ä¸Šå‡ºäº†é—®é¢˜ï¼Œå¯èƒ½æ˜¯æœ‰èŠ‚ç‚¹ä¸ä¸€è‡´ã€‚</p><p>ç¡®å®šäº†æ–¹å‘ï¼Œæ¥ä¸‹æ¥æˆ‘é¦–å…ˆå¯¹å®˜æ–¹åŸ onnx æ¨¡å‹æ–‡ä»¶å’Œæˆ‘è‡ªå·±è®­ç»ƒå¾—åˆ°çš„ onnx æ¨¡å‹ä½¿ç”¨äº† <code>01_checker.sh</code> è„šæœ¬æ¥è¿›è¡Œæ£€æŸ¥ï¼Œå› ä¸ºä»–ä¼šè¾“å‡ºæ¨¡å‹ä¸­çš„å„ä¸ªå±‚ï¼Œå¯¹æ¯”ç»“æœå¦‚ä¸‹ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/compare_checker.png alt=image-20230224192435956></p><p>å·¦ä¾§æ˜¯æˆ‘è‡ªå·±è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹ï¼Œå³ä¾§æ˜¯æˆ‘å®˜æ–¹æä¾›çš„æ¨¡å‹ï¼Œå¯ä»¥å‘ç°ï¼Œä¸¤è€…å­˜åœ¨å·®å¼‚ï¼Œå…¶å®å°±æ˜¯å®˜æ–¹æ¨¡å‹ç›¸æ¯”äºè®­ç»ƒå¾—åˆ°çš„æ¨¡å‹ä¼šå¤šäº†å‡ ä¸ª Mul èŠ‚ç‚¹ã€‚</p><p>æ¥ä¸‹æ¥è¿›ä¸€æ­¥ä½¿ç”¨ netron å·¥å…·å¯¹ä¸¤ä¸ªæ¨¡å‹è¿›è¡Œå¯¹æ¯”ï¼Œæœ‰åŒºåˆ«çš„å¯¹æ¯”ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/compare_netron.png alt=image-20230224193411063></p><p>å·¦ä¾§ä¸ºè‡ªå·±è®­ç»ƒçš„æ¨¡å‹ï¼Œå³ä¾§ä¸ºå®˜æ–¹æ¨¡å‹ã€‚å¯ä»¥çœ‹åˆ°åªæœ‰ bbox ä¿¡æ¯ï¼ˆå¯¹äº FCOS ä¸ºï¼ˆl, t, r, bï¼‰å››å…ƒç»„ï¼‰åœ¨è¾“å‡ºæ—¶ä¸¤ä¸ªæ¨¡å‹æœ‰åŒºåˆ«ï¼Œå¤šäº†ä¸€æ­¥ Relu æ¿€æ´»å‡½æ•°å’Œ Mul èŠ‚ç‚¹ï¼Œå…¶ä»–çš„ç»è¿‡å¯¹æ¯”æ²¡æœ‰åŒºåˆ«ã€‚</p><p>åŒæ—¶è§‚å¯Ÿå‘ç°ï¼Œè¿™é‡Œ Mul èŠ‚ç‚¹å¯¹åº”çš„æ•°å€¼ï¼Œå…¶å®æ˜¯å¯¹åº”çš„ strideï¼ˆè¿™ä¸ªå¤§å®¶å¯ä»¥ä½¿ç”¨ netron å»çœ‹çœ‹ï¼‰</p><p>çŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œè§£å†³æ–¹æ¡ˆå°±æœ‰äº†ï¼Œåªéœ€è¦æ”¹åŠ¨ä¸‹é¢è¿™ä¸€è¡Œå³å¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Decode å‡½æ•°ä¸­è·å–æ•°æ®çš„éƒ¨åˆ†</span>
</span></span><span class=line><span class=cl><span class=c1># å„ä¸ª stride æ‰¾ç¬¦åˆçš„æ¨¡å‹</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>strides</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=bp>cls</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>5</span><span class=p>]</span><span class=o>.</span><span class=n>buffer</span> <span class=o>*</span> <span class=n>strides</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=c1># modified</span>
</span></span><span class=line><span class=cl>        <span class=n>ce</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>10</span><span class=p>]</span><span class=o>.</span><span class=n>buffer</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=n>_scores</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>ce</span><span class=p>)</span>
</span></span></code></pre></div><p>å¾ˆå¥½ç†è§£ï¼Œå¯¹ bbox è·å¾—çš„åŸå§‹æ•°æ®ä¹˜äº† <code>strides[i]</code>ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰å¤„ç† Relu å‡½æ•°ï¼Œå› ä¸ºå³ä½¿æ˜¯è´Ÿæ•°ï¼ŒOpenCV ç»˜åˆ¶ä¹Ÿæ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ã€‚</p><p>å†æ¬¡è¿è¡Œè·å¾—çš„æ¨ç†å›¾å¦‚ä¸‹ï¼Œè¿™æ¬¡æ­£å¸¸äº†ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/good_kite_bbox.png alt=image-20230224194418427></p><p>è‡³æ­¤ï¼Œè®­ç»ƒ mscoco æ•°æ®é›†æ¨¡å‹å¹¶è¿›è¡Œéƒ¨ç½²å°±ç®—ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ¥å¤„ç†è‡ªå·±å¾—åˆ°çš„æ•°æ®é›†ã€‚</p><h2 id=è®­ç»ƒè‡ªé‡‡é›†æ•°æ®é›†>è®­ç»ƒè‡ªé‡‡é›†æ•°æ®é›†<a hidden class=anchor aria-hidden=true href=#è®­ç»ƒè‡ªé‡‡é›†æ•°æ®é›†>#</a></h2><p>å¯¹äºè‡ªé‡‡é›†æ•°æ®é›†ï¼Œæœ€å¯èƒ½æ˜¯æ•°æ®å¤„ç†æ‰“åŒ…ã€ä»¥åŠé…ç½®æ–‡ä»¶çš„é…ç½®è¿™ä¸¤éƒ¨åˆ†å­˜åœ¨é—®é¢˜ï¼Œå‰©ä¸‹çš„æ¨¡å‹æ£€æŸ¥ã€æ ¡å‡†æ•°æ®å‡†å¤‡ã€æ¨¡å‹è½¬åŒ–ã€ä»¥åŠä¸Šæ¿æ¨ç†éƒ¨åˆ†å¯ä»¥è¯´æ˜¯æ ¹æœ¬æ²¡åŒºåˆ«ï¼Œæ‰€ä»¥å°±ç€é‡è®²ä¸€ä¸‹æ•°æ®å‡†å¤‡å’Œé…ç½®éƒ¨åˆ†ã€‚</p><h3 id=æ•°æ®å‡†å¤‡-1>æ•°æ®å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#æ•°æ®å‡†å¤‡-1>#</a></h3><p>é¦–å…ˆæ•°æ®å‡†å¤‡è¦å‡†å¤‡ COCO JSON æ ¼å¼ï¼Œä»–æ˜¯è·Ÿé€šç”¨ JSON æ ¼å¼ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œè¿™ä¸ªå°±ä¸è¯¦è¿°äº†ã€‚</p><p>ç„¶åæ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥å¤ç”¨å®˜æ–¹çš„ <code>mscoco_packer.py</code> è„šæœ¬ï¼Œæˆ‘ä»¬æŠŠæ•°æ®é›†ä¹Ÿå­˜ä¸º <code>train2017</code>ã€<code>val2017</code> å’Œ <code>annotations</code> ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚å­˜åœ¨æ”¾åœ¨ <code>/data/selfcoco</code> ç›®å½•ä¸‹ï¼Œç±»ä¼¼äºä¸‹é¢ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@Z690-P selfcoco<span class=o>]</span><span class=c1># tree</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ annotations
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ instances_train2017.json  <span class=c1># è®­ç»ƒé›†çš„ label</span>
</span></span><span class=line><span class=cl>â”‚Â Â  â””â”€â”€ instances_val2017.json    <span class=c1># éªŒè¯é›†çš„ label</span>
</span></span><span class=line><span class=cl>â”œâ”€â”€ train2017   <span class=c1># è®­ç»ƒé›†ç…§ç‰‡</span>
</span></span><span class=line><span class=cl>â””â”€â”€ val2017     <span class=c1># éªŒè¯é›†ç…§ç‰‡</span>
</span></span></code></pre></div><p>è¿™æ—¶å€™å¦‚æœæˆ‘ä»¬æŒ‰ç…§ä¹‹å‰çš„æ“ä½œï¼Œç›´æ¥ä½¿ç”¨ <code>mscoco_packer.py</code> è„šæœ¬è¿›è¡Œæ‰“åŒ…ï¼Œä¼šæŠ¥é”™å¦‚ä¸‹ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/coco_label_to_label.png alt=image-20230224232516565></p><p>æŠ¥é”™å¤§æ„å°±æ˜¯è®¿é—®äº†å­—å…¸ä¸€ä¸ªä¸å­˜åœ¨çš„é”®ï¼Œç›´æ¥æŸ¥çœ‹æŠ¥é”™çš„ä½ç½®ï¼Œä½äº <code>/usr/local/lib/python3.6/site-packages/hat/data/datasets/mscoco.py</code>ï¼ŒæŸ¥çœ‹åå‘ç° COCO_LABLE_TO_LABLE è¿™ä¸ªå­—å…¸æ˜¯ä¸€ä¸ªç±»åˆ«çš„æ˜ å°„ï¼Œå› ä¸º mscoco æ•°æ®é›†ç±»åˆ«åŒ…å« 80 ç±»ï¼ŒæŒ‰é¡ºåºæ¥æ˜¯ [0, 80)ï¼Œä½†æ˜¯ mscoco æ•°æ®é›†åŸæ•°æ®é›†ç±»åˆ«åºå·èŒƒå›´ä¸º [1, 90]ï¼Œä½†æ˜¯å…¶ä¸­åªæœ‰ 80 ä¸ªç±»åˆ«åºå·ï¼Œæ‰€ä»¥éœ€è¦åšä¸€ä¸ª [1, 90] -> [0, 80) çš„ç±»åˆ«æ˜ å°„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è‡ªåˆ¶çš„æ•°æ®é›†æ²¡æœ‰è¿™ä¸ªç±»åˆ«æ˜ å°„çš„éœ€æ±‚ï¼Œå°±ä¸éœ€è¦æ˜ å°„ï¼ŒæŠŠæ¶‰åŠåˆ°è¿™ä¸ª Dict çš„ä¸¤è¡Œéƒ½å»æ‰å³å¯ã€‚</p><p>Btwï¼šğŸ¤£ è¿™é‡Œçš„ COCO_LABLE_TO_LABLE æ˜¯ä¸æ˜¯æ‹¼é”™äº†ï¼Œè¦æ‹¼ LABEL çš„ï¼Ÿ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 229 è¡Œ</span>
</span></span><span class=line><span class=cl><span class=c1># anno[0, 4] = COCO_LABLE_TO_LABLE[tar[&#34;category_id&#34;]]</span>
</span></span><span class=line><span class=cl><span class=n>anno</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>tar</span><span class=p>[</span><span class=s2>&#34;category_id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># 327 è¡Œ</span>
</span></span><span class=line><span class=cl><span class=c1># np.array([[COCO_LABLE_TO_LABLE[tar[&#34;category_id&#34;]]]])</span>
</span></span><span class=line><span class=cl><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=n>tar</span><span class=p>[</span><span class=s2>&#34;category_id&#34;</span><span class=p>]]])</span>
</span></span></code></pre></div><p>éšåæ‰“åŒ…å³å¯</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è½¬æ¢è®­ç»ƒé›†</span>
</span></span><span class=line><span class=cl>python3 tools/datasets/mscoco_packer.py --src-data-dir /data/selfcoco --target-data-dir /data/selfcoco --split-name train --pack-type lmdb
</span></span><span class=line><span class=cl><span class=c1># è½¬æ¢éªŒè¯é›†</span>
</span></span><span class=line><span class=cl>python3 tools/datasets/mscoco_packer.py --src-data-dir /data/selfcoco --target-data-dir /data/selfcoco --split-name val --pack-type lmdb
</span></span></code></pre></div><h3 id=é…ç½®æ–‡ä»¶ä¿®æ”¹>é…ç½®æ–‡ä»¶ä¿®æ”¹<a hidden class=anchor aria-hidden=true href=#é…ç½®æ–‡ä»¶ä¿®æ”¹>#</a></h3><p>é…ç½®æ–‡ä»¶<strong>é™¤äº†ä¹‹å‰æåˆ°çš„ä¸‰å¤„éœ€è¦ä¿®æ”¹</strong>ï¼Œé…ç½®æ–‡ä»¶ä¸­è¿˜éœ€è¦ä¿®æ”¹ä¸ç±»åˆ«ç›¸å…³çš„å‚æ•°ï¼Œå¤§æ¦‚æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š</p><ol><li><code>num_classes</code>ï¼šè¿™é‡Œå°±æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ç±»åˆ«æ•°ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œæœ‰äº”ç±» [0, 5)ï¼Œé‚£æ”¹ä¸º 5 å³å¯ã€‚</li><li><code>model</code>ï¼šmodel å‚æ•°ä¸­è¿˜æœ‰å¾ˆå¤šæ¶‰åŠåˆ° 80 çš„ï¼Œç»è¿‡æˆ‘æŸ¥çœ‹æºç åï¼Œå‘ç°è¿™äº› 80 çš„ä½ç½®éƒ½åº”è¯¥æ”¹æˆ num_classes å‚æ•°æ‰å¯ä»¥ï¼Œä¾‹å¦‚ model ä¸­çš„ loss_cls å‚æ•°ï¼Œå…¶ä¸­çš„ num_classes å‚æ•°å€¼ 80+1 å°±éœ€è¦æ”¹ä¸º <code>num_classes + 1</code> ï¼Œpost_process å‚æ•°ä¸­çš„ num_classes å‚æ•°å€¼ 80 ä¹Ÿåº”è¯¥æ”¹ä¸º <code>num_classes</code>ï¼Œè¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯å®˜æ–¹çš„ç–å¿½ï¼Œåº”è¯¥æ˜¯å¿˜è®°æ”¹äº†ã€‚</li></ol><p>ä¿®æ”¹å®Œåå°±å¯ä»¥æŒ‰ä¹‹å‰çš„æ–¹æ³•è¿›è¡Œè®­ç»ƒäº†ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># è¿›å…¥ horizon_model_train_samples ç›®å½•</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /open_explorer/ddk/samples/ai_toolchain/horizon_model_train_samples
</span></span><span class=line><span class=cl><span class=c1># å¼€å§‹è®­ç»ƒ</span>
</span></span><span class=line><span class=cl>python3 tools/train.py --step float --config configs/detection/fcos/fcos_efficientnetb0_mscoco.py
</span></span></code></pre></div><h3 id=æ ¡å‡†æ•°æ®å‡†å¤‡>æ ¡å‡†æ•°æ®å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#æ ¡å‡†æ•°æ®å‡†å¤‡>#</a></h3><p>è¿™é‡Œé¢„å¤„ç†çš„æ•°æ®ä¹Ÿåº”è¯¥é€‰æ‹©æˆ‘ä»¬è®­ç»ƒçš„æ•°æ®å­é›†ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œå‰©ä¸‹çš„éƒ½ä¸éœ€è¦å˜ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 02_preprocess.sh</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e -v
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=k>$(</span>dirname <span class=nv>$0</span><span class=k>)</span> <span class=o>||</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python3 ../../../data_preprocess.py <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --src_dir /data/selfcoco/train2017 <span class=se>\ </span><span class=c1># é‡è¦</span>
</span></span><span class=line><span class=cl>  --dst_dir ./calibration_data_yuv_f32 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cal_img_num <span class=m>50</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --pic_ext .yuv <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --read_mode opencv <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --saved_data_type float32
</span></span></code></pre></div><h3 id=æ¨ç†ä»£ç ä¿®æ”¹>æ¨ç†ä»£ç ä¿®æ”¹<a hidden class=anchor aria-hidden=true href=#æ¨ç†ä»£ç ä¿®æ”¹>#</a></h3><p>è¿™é‡Œéœ€è¦ä¿®æ”¹ <code>get_classes</code> å‡½æ•°è¿”å›çš„ç±»åˆ«åï¼Œæ”¹æˆè‡ªå·±å¯¹åº”çš„ç±»åˆ« List.</p><p>æ¨ç†å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p><p><img loading=lazy src=/images/hat-train-fcos/self_coco_bbox.png alt=image-20230225000213268></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯†åˆ«å¯ä»¥æ­£å¸¸çš„å·¥ä½œï¼ˆå› ä¸ºæˆ‘é€‰çš„è®­ç»ƒæ•°æ®é›†æœ‰ç‚¹æï¼Œæ‰€ä»¥è¿‡æ‹Ÿåˆæ¯”è¾ƒä¸¥é‡ï¼Œå°±é€‰äº†ä¸€å¼ å‡‘åˆèƒ½çœ‹çš„å›¾ï¼Œå¤§å®¶è§è°…ï¼‰ã€‚</p><h2 id=åè¨€>åè¨€<a hidden class=anchor aria-hidden=true href=#åè¨€>#</a></h2><p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº† FCOS ç½‘ç»œçš„è®­ç»ƒå’Œéƒ¨ç½²ï¼Œä½†æ˜¯åŸºäº Python çš„æ¨ç†å¯èƒ½æœ‰ç‚¹æ…¢ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒ ai_benchmark ç­‰éƒ¨åˆ†è¿›è¡Œ C++ æ¨ç†ï¼Œä¸»è¦å…³é”®å°±æ˜¯ PostProcess åå¤„ç†éƒ¨åˆ†ï¼Œä¸è¿‡ä¹‹å‰ <a href="https://developer.horizon.ai/college/detail/id=89018995415500842">å¼€å‘è€…ç›´æ’­KEâ€”â€”AIæ¿ç«¯éƒ¨ç½²å®è·µ</a> å¼ è€å¸ˆå·²ç»è®²è¿‡ä¸€éƒ¨åˆ† APIï¼Œå¦‚æœå¤§å®¶æœ‰å…´è¶£ï¼Œæˆ‘åé¢ä¹Ÿå¯ä»¥ç»™å¤§å®¶å‡ºä¸ªå¸–å­è®²è®² ğŸ¤—ã€‚</p><p>æ¢ç´¢çš„è¿™å‡ å¤©ï¼Œç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ï¼Œ<strong>åœ°å¹³çº¿åšäº†å¾ˆå¤šï¼Œå†™äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥å…·ã€åŒ…ï¼Œä½†æ˜¯æ–‡æ¡£è¿˜æ˜¯ä¸å¤Ÿå®Œå–„</strong>ï¼Œè€Œä¸”æ–‡æ¡£æœ‰äº›æ··ä¹±ï¼Œç‰ˆæœ¬æ¯”è¾ƒæ··ä¹±ï¼Œä½ç½®æ¯”è¾ƒæ··ä¹±ã€ç­‰ç­‰ï¼Œå®¹æ˜“æ‰¾ä¸åˆ°ã€æ— ä»ä¸‹æ‰‹ç­‰ç­‰ã€‚</p><p>ä¾‹å¦‚å¯¹äº FCOS è¿™éƒ¨åˆ†çš„æ–‡æ¡£å°±å¾ˆæ¬ ç¼ºï¼Œå¯¹äº FCOS è®­ç»ƒé…ç½®çš„å„ä¸ªé€‰é¡¹çš„è¯¦è§£ï¼Œå¤§å®¶çœ‹åˆ°æ—¶å€™å¯èƒ½ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p><ol><li>å¦‚ä½•ä½¿ç”¨ CPU è¿›è¡Œè®­ç»ƒè€Œä¸æ˜¯ GPUï¼Ÿ</li><li>å¦‚ä½•åŸºäºå·²æœ‰çš„æ¨¡å‹è¿›è¡Œè¿ç§»è®­ç»ƒï¼Ÿä¸­æ–­è®­ç»ƒåå¯ä»¥å†ç»§ç»­è¿›è¡Œå—ï¼Ÿ</li><li>å¯ä»¥ freeze ä¸€éƒ¨åˆ†å‚æ•°è¿›è¡Œ fine-tuning å—ï¼Ÿ</li><li>è®­ç»ƒæ—¶æœ‰æ•°æ®å¢å¼ºå—ï¼Ÿå¦‚æœä¸éœ€è¦å¯ä»¥å»æ‰å—ï¼Ÿ</li></ol><p>ä¸è¿‡ç°åœ¨ä¹Ÿæ˜¯åœ¨æ…¢æ…¢å®Œå–„ï¼Œä¸æ–­è¿›æ­¥ï¼Œå¸Œæœ›å¯ä»¥æŠŠè¿™äº›å¥½ç”¨çš„ä¸œè¥¿éƒ½èƒ½è®©å¤§å®¶å¿«ç‚¹æ–¹ä¾¿çš„ç”¨èµ·æ¥ã€‚</p><p>æ–‡ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›ä»£ç ã€è„šæœ¬å’Œæ¨¡å‹ç­‰ï¼Œå¯ä»¥åœ¨ <a href=https://github.com/zzsqwq/fcos_tutorial>Github ä»“åº“</a> ä¸­æ‰¾åˆ°ã€‚</p><p>æ–‡ç« åŒæ­¥å‘å¸ƒåœ¨æˆ‘çš„åšå®¢ï¼šhttps://blog.zzsqwq.cn</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://developer.horizon.ai/forumDetail/118363910641451905>å¦‚ä½•ç”¨å·¥å…·é“¾HATè®­ç»ƒfcosè‡ªå®šä¹‰æ•°æ®é›†</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://developer.horizon.ai/forumDetail/118363914936419315>åœ¨OEåŒ…ä¸­è®­ç»ƒfocsæ¨¡å‹</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.zzsqwq.cn/tags/hat/>HAT</a></li><li><a href=https://blog.zzsqwq.cn/tags/horizon-robotics/>Horizon Robotics</a></li><li><a href=https://blog.zzsqwq.cn/tags/fcos/>FCOS</a></li></ul><nav class=paginav><a class=prev href=https://blog.zzsqwq.cn/posts/why-should-boycott-pdd/><span class=title>Â« Prev</span><br><span>ä¸ºä»€ä¹ˆåº”è¯¥æŠµåˆ¶æ‹¼å¤šå¤šï¼Ÿ</span></a>
<a class=next href=https://blog.zzsqwq.cn/posts/summary-2022/><span class=title>Next Â»</span><br><span>2022 å¹´åº¦æ€»ç»“</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.zzsqwq.cn>Zs's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>